<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Home - DoctorPod</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #0ea5e9;
      --primary-hover: #0284c7;
      --bg: #f0f9ff;
      --surface: #ffffff;
      --text: #0c4a6e;
      --text-muted: #64748b;
      --border: #bae6fd;
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: nowrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--text);
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .logo > div {
      min-width: 0;
      overflow: hidden;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.125rem;
      background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .logo-subtitle {
      font-size: 0.625rem;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--bg);
    }

    .btn-profile {
      background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
      color: white;
      border: none;
    }

    .btn-profile:hover {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .refresh-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
      border: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
    }

    .refresh-btn .refresh-icon {
      display: inline-block;
      transition: none;
    }

    .refresh-btn.loading .refresh-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile optimization for header buttons */
    @media (max-width: 768px) {
      .header {
        padding: 0.5rem 0.5rem;
      }

      .header-content {
        gap: 0.25rem;
      }

      .logo {
        gap: 0.25rem;
        flex: 0 1 auto;
        min-width: 0;
        max-width: 50%;
      }

      .logo > div {
        min-width: 0;
        overflow: hidden;
      }

      .logo-icon {
        width: 30px;
        height: 30px;
        flex-shrink: 0;
      }

      .logo-text {
        font-size: 0.75rem;
        line-height: 1.2;
      }

      .logo-subtitle {
        font-size: 0.5rem;
        line-height: 1.2;
      }

      .header-right {
        gap: 0.25rem;
        flex: 0 0 auto;
      }

      .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.6875rem;
        white-space: nowrap;
      }

      .top-stats {
        gap: 0.4rem !important;
      }

      .top-stats > div {
        padding: 0.5rem 0.4rem !important;
        gap: 0.3rem !important;
      }

      .top-stats .stat-label {
        font-size: 0.65rem !important;
      }

      .top-stats .stat-value {
        font-size: 1.125rem !important;
      }

      .revenue-stats {
        gap: 0.35rem !important;
      }

      .revenue-card {
        padding: 0.5rem 0.35rem !important;
      }

      .revenue-label {
        font-size: 0.6rem !important;
        margin-bottom: 0.25rem !important;
      }

      .revenue-value {
        font-size: 0.95rem !important;
      }

      .revenue-subtext {
        font-size: 0.55rem !important;
        margin-top: 0.15rem !important;
      }

      .quick-links-buttons {
        gap: 0.35rem !important;
      }

      .quick-link-btn {
        font-size: 0.7rem !important;
        padding: 0.5rem 0.4rem !important;
      }

      .appointments-header {
        padding: 0.875rem 1rem !important;
      }

      .appointments-title {
        font-size: 1rem !important;
      }

      .refresh-btn {
        padding: 0.375rem 0.75rem;
      }

      .appointment-filters {
        padding: 0.75rem !important;
      }

      .appointment-filters > div {
        flex-wrap: nowrap !important;
        gap: 0.5rem !important;
      }

      .appointment-filters input,
      .appointment-filters select,
      .appointment-filters button {
        font-size: 0.7rem !important;
        padding: 0.35rem 0.4rem !important;
        min-width: auto !important;
      }

      .appointment-filters input[type="date"] {
        width: 110px !important;
        min-width: 110px !important;
      }

      .appointment-filters .filter-btn {
        white-space: nowrap !important;
        padding: 0.35rem 0.5rem !important;
      }

      .appointment-filters select {
        flex: 1 !important;
        min-width: 100px !important;
      }

      .qr-section {
        padding: 0 !important;
      }

      .qr-header {
        padding: 0.875rem 1rem !important;
      }

      .qr-title {
        font-size: 1rem !important;
      }

      .qr-header .collapse-icon {
        font-size: 1rem !important;
      }

      .qr-body {
        padding: 0.75rem !important;
      }

      .qr-content {
        gap: 0.75rem !important;
      }

      .qr-container {
        padding: 0.5rem !important;
      }

      .qr-image {
        min-height: 120px !important;
        min-width: 120px !important;
      }

      .qr-info {
        text-align: center;
        min-width: auto !important;
      }

      .qr-description {
        font-size: 0.75rem !important;
        margin-bottom: 0.5rem !important;
      }

      .qr-actions {
        justify-content: center !important;
      }

      .qr-actions button {
        font-size: 0.75rem !important;
        padding: 0.375rem 0.5rem !important;
      }

      .billing-body {
        padding: 0.75rem !important;
      }

      .checkouts-container,
      .invoices-container {
        padding: 0.75rem !important;
        margin-bottom: 1rem !important;
      }

      .checkouts-header,
      .invoices-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem !important;
      }

      .checkouts-title,
      .invoices-title {
        font-size: 1rem !important;
      }

      .invoice-filters {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
        padding: 0.5rem !important;
      }

      .invoice-filters > div {
        display: flex;
        flex-direction: column;
      }

      .invoice-filters label {
        font-size: 0.65rem !important;
        margin-bottom: 0.15rem !important;
        white-space: nowrap;
      }

      .invoice-filters input,
      .invoice-filters select {
        font-size: 0.7rem !important;
        padding: 0.35rem 0.4rem !important;
      }

      .checkout-card {
        flex-direction: column !important;
        align-items: flex-start !important;
        padding: 0.75rem !important;
      }

      .checkout-patient {
        font-size: 0.875rem !important;
      }

      .checkout-details {
        font-size: 0.75rem !important;
      }

      .checkout-fee {
        font-size: 0.75rem !important;
      }

      .checkout-btn {
        width: 100% !important;
        margin-top: 0.5rem !important;
        font-size: 0.875rem !important;
      }

      .invoice-table th,
      .invoice-table td {
        padding: 0.5rem 0.35rem !important;
        font-size: 0.7rem !important;
      }

      .inv-col-doctor,
      .inv-col-date {
        display: none;
      }

      .invoice-table .btn {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.35rem !important;
      }

      .appointments-table th,
      .appointments-table td {
        padding: 0.5rem 0.375rem !important;
        font-size: 0.75rem !important;
      }

      .apt-col-date {
        display: none;
      }
    }

    /* Main Content */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* Welcome Card - Below Header */
    .welcome-card {
      background: linear-gradient(135deg, #0ea5e9 0%, #0891b2 100%);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .clinic-name {
      font-size: 1.125rem;
      font-weight: 700;
      color: white;
    }

    .clinic-address {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
    }

    /* Stats Grid */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .stat-label::after {
      content: ':';
      margin-left: 0.25rem;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }

    .stat-card.primary .stat-value { color: var(--primary); }
    .stat-card.success .stat-value { color: var(--success); }
    .stat-card.warning .stat-value { color: var(--warning); }

    /* Stats Grid */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .stat-label::after {
      content: ':';
      margin-left: 0.25rem;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }

    .stat-card.primary .stat-value { color: var(--primary); }
    .stat-card.success .stat-value { color: var(--success); }
    .stat-card.warning .stat-value { color: var(--warning); }

    /* Filter Buttons */
    .filter-btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: var(--bg);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Appointments Table */
    #appointmentsTable tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    #appointmentsTable tbody tr:hover {
      background: var(--bg);
    }

    #appointmentsTable tbody td {
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    .dashboard-section {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .dashboard-section h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: 700;
    }

    .dashboard-section p {
      color: var(--text-muted);
      margin-bottom: 0;
      font-size: 0.9375rem;
    }
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9375rem;
      margin-top: 0.75rem;
    }

    .dashboard-section {
      background: var(--surface);
      border-radius: 12px;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
      margin-bottom: 2rem;
    }

    .dashboard-section h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .dashboard-section p {
      color: var(--text-muted);
      margin-bottom: 2rem;
      font-size: 1.0625rem;
    }

    .btn-large {
      padding: 1.25rem 3rem;
      font-size: 1.125rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .btn-large:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
    }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .quick-link {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      text-align: center;
      transition: all 0.2s;
      box-shadow: var(--shadow);
    }

    .quick-link:hover {
      box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
      transform: translateY(-2px);
    }

    .quick-link h3 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .quick-link p {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    /* Section */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .section-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg);
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-body {
      padding: 1.5rem;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
    }

    .form-input {
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9375rem;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--surface);
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      min-width: 500px;
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: var(--text);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      color: var(--text);
      padding-right: 2rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .profile-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s;
      background: var(--bg);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--surface);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .form-group input:disabled {
      background: #f9fafb;
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .form-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 300px;
      max-width: 400px;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 1rem 1.25rem;
      display: none;
      align-items: flex-start;
      gap: 0.75rem;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
    }

    .toast.show {
      display: flex;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOut 0.3s ease-out forwards;
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .toast-success .toast-icon {
      background: #dbeafe;
      color: var(--primary);
    }

    .toast-error .toast-icon {
      background: #fee2e2;
      color: #dc2626;
    }

    .toast-warning .toast-icon {
      background: #fef3c7;
      color: #f59e0b;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text);
      margin-bottom: 0.125rem;
    }

    .toast-message {
      font-size: 0.875rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .toast-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .header-right {
        justify-content: space-between;
      }

      .welcome-card {
        padding: 0.875rem 1rem;
      }

      .dashboard-section {
        padding: 2rem 1.5rem;
      }

      .btn-large {
        padding: 1rem 2rem;
        font-size: 1rem;
      }

      .modal-content {
        min-width: auto;
        padding: 2rem 1.5rem;
        max-width: 95vw;
      }

      .tabs {
        gap: 0.25rem;
      }

      .tab {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
      }

      .btn-group {
        flex-direction: column;
      }

      .form-actions {
        flex-direction: column;
      }

      .toast {
        right: 10px;
        left: 10px;
        min-width: auto;
        top: 10px;
      }

      /* Invoice Modal - Mobile Responsive */
      #invoiceModal {
        padding: 0.25rem !important;
      }

      #invoiceModal > div {
        max-height: 98vh;
        border-radius: 8px;
      }

      #invoiceModal .invoice-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 0.375rem !important;
      }

      #invoiceModal input[type="number"],
      #invoiceModal input[type="text"],
      #invoiceModal select,
      #invoiceModal textarea {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 0.5rem !important;
      }

      /* Billing stats bar - mobile */
      .billing-stats {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.375rem !important;
        padding: 0.5rem !important;
      }

      .billing-stats > div {
        padding: 0.375rem 0.5rem !important;
      }

      .billing-stats > div span:first-child {
        font-size: 0.625rem !important;
      }

      .billing-stats > div span:last-child {
        font-size: 0.875rem !important;
      }

      /* Appointments stats bar - mobile */
      .appointments-stats {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 0.25rem !important;
        padding: 0.5rem !important;
      }

      .appointments-stats > div {
        padding: 0.375rem 0.25rem !important;
      }

      .appointments-stats > div span:first-child {
        font-size: 0.5625rem !important;
      }

      .appointments-stats > div span:last-child {
        font-size: 0.875rem !important;
      }

      /* Video stats bar - mobile */
      .video-stats {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.375rem !important;
        padding: 0.5rem !important;
      }

      .video-stats > div {
        padding: 0.375rem 0.5rem !important;
      }

      .video-stats > div span:first-child {
        font-size: 0.625rem !important;
      }

      .video-stats > div span:last-child {
        font-size: 0.875rem !important;
      }
    }

    /* Extra small screens */
    @media (max-width: 380px) {
      #invoiceModal .invoice-grid {
        grid-template-columns: 1fr !important;
      }
      
      #videoPaymentFilter {
        width: 100%;
        font-size: 16px; /* Prevent iOS zoom */
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <img id="headerClinicLogo" src="" alt="Clinic Logo" class="logo-icon" style="display: none;" />
        <div>
          <div class="logo-text" id="headerClinicName">Clinic</div>
          <div class="logo-subtitle" id="headerClinicAddress">Loading...</div>
        </div>
      </div>
      
      <div class="header-right">
        <button class="btn btn-profile" id="manageProfileBtn">Manage Profile</button>
        <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Quick Actions Card -->
  <div class="quick-links-card" style="background: white; padding: 0.75rem 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
    <div class="quick-links-title" style="text-align: center; font-size: 0.875rem; font-weight: 700; color: #2265d1; margin-bottom: 0.75rem;">Quick links</div>
    <div class="quick-links-buttons" style="display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: nowrap;">
      <button class="btn quick-link-btn" onclick="window.location.href='/clinic/manage-doctors'" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 0.75rem; font-size: 0.8rem; font-weight: 600; white-space: nowrap; flex: 1; min-width: 0; max-width: 180px;">
        Manage Doctors
      </button>
      <button class="btn quick-link-btn" onclick="window.location.href='/patient_booking.html?from=clinic'" style="background: #10b981; color: white; border: none; padding: 0.5rem 0.75rem; font-size: 0.8rem; font-weight: 600; white-space: nowrap; flex: 1; min-width: 0; max-width: 180px;">
        Book Appointment
      </button>
      <button class="btn quick-link-btn" onclick="window.location.href='/check_booking.html?from=clinic'" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 0.75rem; font-size: 0.8rem; font-weight: 600; white-space: nowrap; flex: 1; min-width: 0; max-width: 180px;">
        Check Booking
      </button>
    </div>
  </div>

  <main class="container">

    <!-- ========== TODAY'S APPOINTMENTS SECTION (HIGHEST PRIORITY) ========== -->
    <div class="section appointments-section" style="background: white; border-radius: 12px; padding: 0; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div class="section-header clickable appointments-header" onclick="toggleAppointmentsSection()" style="background: #d1fae5; color: #065f46; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0; border-bottom: 1px solid #a7f3d0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="appointments-title" style="font-size: 1.25rem; font-weight: 700; margin: 0;" id="appointmentsHeading">ğŸ“… Today's Appointments</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="appointmentsRefreshBtn" class="btn btn-sm refresh-btn" onclick="event.stopPropagation(); refreshAppointmentsWithSpin();" title="Refresh appointments"><span class="refresh-icon">âŸ³</span> Refresh</button>
          <span class="collapse-icon" id="appointmentsIcon" style="font-size: 1.25rem; transition: transform 0.3s ease;">â–¼</span>
        </div>
      </div>
      
      <!-- Stats Bar (inline with header) -->
      <div class="appointments-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
        <div style="background: white; border: 1px solid #e0e7ff; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Doctors:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #6366f1;" id="totalDoctors">0</span>
        </div>
        <div style="background: white; border: 1px solid #dcfce7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Active:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #10b981;" id="activeToday">0</span>
        </div>
        <div style="background: white; border: 1px solid #fef3c7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Bookings:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #f59e0b;" id="totalAppointments">0</span>
        </div>
      </div>
      
      <div class="section-body" id="appointmentsBody" style="padding: 0;">

        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
          <span id="loadingAppointments">â³ Loading appointments...</span>
        </div>
        
        <!-- Filter Tabs -->
        <div class="appointment-filters" style="display: none; padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg);" id="appointmentFilters">
          <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
            <input type="date" id="dateFilter" class="form-input" style="padding: 0.5rem; font-size: 0.875rem; width: auto; min-width: 150px;" onchange="selectDate()" />
            <button class="filter-btn" onclick="selectAllDates()" style="white-space: nowrap;">ğŸ“‹ All Dates</button>
            <select id="modeFilter" class="form-select" onchange="applyFilters()" style="padding: 0.5rem; font-size: 0.875rem; min-width: 110px;">
              <option value="">All Modes</option>
              <option value="clinic">ğŸ¥ Clinic</option>
              <option value="video">ğŸ“¹ Video</option>
            </select>
            <select id="doctorFilter" class="form-select" onchange="applyFilters()" style="padding: 0.5rem; font-size: 0.875rem; flex: 1; min-width: 100px;">
              <option value="">All Doctors</option>
            </select>
          </div>
        </div>
        
        <!-- Appointments Table -->
        <div style="display: none; overflow-x: auto;" id="appointmentsTable">
          <table class="appointments-table" style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
              <tr>
                <th class="apt-col-id" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #64748b;">ğŸ« Booking ID</th>
                <th class="apt-col-queue" style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: #64748b;">#ï¸âƒ£ Queue</th>
                <th class="apt-col-patient" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #64748b;">ğŸ‘¤ Patient</th>
                <th class="apt-col-doctor" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #64748b;">ğŸ‘¨â€âš•ï¸ Doctor</th>
                <th class="apt-col-datetime" style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: #64748b;">ğŸ“… Schedule</th>
                <th class="apt-col-status" style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: #64748b;">âš¡ Status</th>
              </tr>
            </thead>
            <tbody id="appointmentsTableBody">
              <!-- Rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== BILLING & INVOICES SECTION ========== -->
    <div class="section billing-section" style="background: white; border-radius: 12px; padding: 0; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div class="section-header clickable billing-header" onclick="toggleBillingSection()" style="background: #dbeafe; color: #1e40af; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0; border-bottom: 1px solid #bfdbfe; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="billing-title" style="font-size: 1.25rem; font-weight: 700; margin: 0;">ğŸ’° Billing & Invoices</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="billingRefreshBtn" class="btn btn-sm refresh-btn" onclick="event.stopPropagation(); refreshBillingStats();" title="Refresh stats"><span class="refresh-icon">âŸ³</span> Refresh</button>
          <span class="collapse-icon" id="billingIcon" style="font-size: 1.25rem; transition: transform 0.3s ease; transform: rotate(-90deg);">â–¼</span>
        </div>
      </div>
      
      <!-- Revenue Stats Bar (like Today's Appointments) -->
      <div class="billing-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
        <div style="background: white; border: 1px solid #dcfce7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Today:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #10b981;" id="statTodayRevenue">â‚¹0</span>
        </div>
        <div style="background: white; border: 1px solid #fef3c7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Pending:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #f59e0b;" id="statPendingPayments">â‚¹0</span>
        </div>
        <div style="background: white; border: 1px solid #dbeafe; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Month:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #0ea5e9;" id="statMonthRevenue">â‚¹0</span>
        </div>
        <div style="background: white; border: 1px solid #f3e8ff; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">Checkouts:</span>
          <span style="font-size: 1rem; font-weight: 700; color: #8b5cf6;" id="statTodayCheckouts">0</span>
        </div>
      </div>
      
      <div class="section-body billing-body" id="billingBody" style="padding: 1.5rem; display: none;">

        <!-- Today's Checkouts -->
        <div class="checkouts-container" style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 2px solid #e2e8f0;">
          <div class="checkouts-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 class="checkouts-title" style="font-size: 1.125rem; font-weight: 600; color: #1e293b;">ğŸ›’ Today's Checkouts</h3>
            <button id="checkoutsRefreshBtn" onclick="refreshCheckouts()" class="btn btn-sm refresh-btn"><span class="refresh-icon">âŸ³</span> Refresh</button>
          </div>
          <div id="todaysCheckoutsList" class="loading" style="min-height: 100px;">
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
              <div>Loading checkouts...</div>
            </div>
          </div>
        </div>

        <!-- Invoice Management -->
        <div class="invoices-container" style="background: white; border-radius: 12px; padding: 1.5rem; border: 2px solid #e2e8f0;">
          <div class="invoices-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 class="invoices-title" style="font-size: 1.125rem; font-weight: 600; color: #1e293b;">ğŸ“‹ Invoice Management</h3>
            <button id="invoicesRefreshBtn" onclick="refreshInvoices()" class="btn btn-sm refresh-btn"><span class="refresh-icon">âŸ³</span> Refresh</button>
          </div>
          
          <!-- Filters -->
          <div class="invoice-filters" style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
            <select id="invoiceStatusFilter" class="form-input" onchange="loadAllInvoices()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; min-width: 120px; border-radius: 6px;">
              <option value="all">ğŸ“Š All Status</option>
              <option value="unpaid">ğŸ”´ Unpaid</option>
              <option value="paid">ğŸŸ¢ Paid</option>
            </select>
            <select id="invoiceModeFilter" class="form-input" onchange="loadAllInvoices()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; min-width: 110px; border-radius: 6px;">
              <option value="all">All Modes</option>
              <option value="clinic">ğŸ¥ Clinic</option>
              <option value="video">ğŸ“¹ Video</option>
            </select>
            <div style="display: flex; align-items: center; gap: 0.375rem;">
              <span style="font-size: 0.8125rem; color: #64748b; font-weight: 500;">From</span>
              <input type="date" id="invoiceStartDate" class="form-input" style="padding: 0.5rem; font-size: 0.875rem; width: auto; min-width: 140px; border-radius: 6px;" onchange="loadAllInvoices()" />
            </div>
            <div style="display: flex; align-items: center; gap: 0.375rem;">
              <span style="font-size: 0.8125rem; color: #64748b; font-weight: 500;">To</span>
              <input type="date" id="invoiceEndDate" class="form-input" style="padding: 0.5rem; font-size: 0.875rem; width: auto; min-width: 140px; border-radius: 6px;" onchange="loadAllInvoices()" />
            </div>
            <input type="text" id="invoicePatientSearch" class="form-input" placeholder="ğŸ” Search patient..." oninput="loadAllInvoices()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; min-width: 150px; border-radius: 6px; flex: 1;" />
          </div>
          
          <div id="allInvoicesList" class="loading" style="min-height: 200px;">
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
              <div>Loading invoices...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Prescription Search Section -->
    <div class="section prescription-section" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div class="section-header clickable prescription-header" onclick="togglePrescriptionSection()" style="background: #fce7f3; color: #9d174d; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0; border-bottom: 1px solid #fbcfe8; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="prescription-title" style="font-size: 1.25rem; font-weight: 700; margin: 0;">ğŸ“‹ Patient Prescriptions</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="prescriptionRefreshBtn" class="btn btn-sm refresh-btn" onclick="event.stopPropagation(); searchPrescriptions();" title="Refresh"><span class="refresh-icon">âŸ³</span> Refresh</button>
          <span class="collapse-icon" id="prescriptionIcon" style="font-size: 1.25rem; transition: transform 0.3s ease; transform: rotate(-90deg);">â–¼</span>
        </div>
      </div>
      
      <div class="section-body prescription-body" id="prescriptionBody" style="padding: 1.5rem; display: none;">
        <!-- Search Filters -->
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
          <div style="flex: 1; min-width: 150px;">
            <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: 600;">ğŸ“… Visit Date</label>
            <input type="date" id="prescriptionDateFilter" class="form-input" style="width: 100%; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="searchPrescriptions()" />
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: 600;">ğŸ“± Patient Mobile</label>
            <input type="tel" id="prescriptionMobileFilter" class="form-input" placeholder="Enter 10-digit mobile" maxlength="10" pattern="[0-9]{10}" style="width: 100%; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #e2e8f0; border-radius: 6px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: 600;">ğŸ‘¨â€âš•ï¸ Doctor</label>
            <select id="prescriptionDoctorFilter" class="form-input" style="width: 100%; padding: 0.5rem; font-size: 0.875rem; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="searchPrescriptions()">
              <option value="">All Doctors</option>
            </select>
          </div>
          <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
            <button onclick="searchPrescriptions()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">ğŸ” Search</button>
            <button onclick="clearPrescriptionFilters()" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Clear</button>
          </div>
        </div>

        <!-- Results Stats -->
        <div id="prescriptionStats" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: #ecfdf5; border-radius: 8px; border: 1px solid #a7f3d0;">
          <span style="font-size: 0.875rem; color: #065f46; font-weight: 600;">
            <span id="prescriptionResultCount">0</span> prescription(s) found
          </span>
        </div>

        <!-- Results Table -->
        <div id="prescriptionTableContainer" style="overflow-x: auto;">
          <table id="prescriptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem; display: none;">
            <thead>
              <tr style="background: #f1f5f9; text-align: left;">
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569;">Date</th>
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569;">Patient</th>
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569;">Mobile</th>
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569;">Doctor</th>
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569;">Diagnosis</th>
                <th style="padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569; text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="prescriptionTableBody">
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="prescriptionEmptyState" style="text-align: center; padding: 2rem; color: #64748b;">
          <div style="font-size: 3rem; margin-bottom: 0.75rem;">ğŸ“‹</div>
          <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">Search for Patient Prescriptions</div>
          <div style="font-size: 0.875rem;">Enter visit date or patient mobile number to find prescriptions</div>
        </div>

        <!-- Loading State -->
        <div id="prescriptionLoading" style="display: none; text-align: center; padding: 2rem; color: #64748b;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
          <div style="font-size: 0.875rem;">Searching prescriptions...</div>
        </div>
      </div>
    </div>

    <!-- Video Consultations Section -->
    <div class="section video-section" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div class="section-header clickable video-header" onclick="toggleVideoSection()" style="background: #dbeafe; color: #1e40af; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0; border-bottom: 1px solid #bfdbfe; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="video-title" style="font-size: 1.25rem; font-weight: 700; margin: 0;">ğŸ“¹ Video Consultations</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button id="videoRefreshBtn" class="btn btn-sm refresh-btn" onclick="event.stopPropagation(); loadVideoConsultationsDetailList();" title="Refresh"><span class="refresh-icon">âŸ³</span> Refresh</button>
          <span class="collapse-icon" id="videoIcon" style="font-size: 1.25rem; transition: transform 0.3s ease; transform: rotate(-90deg);">â–¼</span>
        </div>
      </div>
      
      <!-- Video Stats Bar -->
      <div class="video-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
        <div style="background: white; border: 1px solid #dbeafe; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">ğŸ“‹</span>
          <span style="font-size: 0.875rem; font-weight: 700; color: #2563eb;" id="videoQueueCount">0 Queue</span>
        </div>
        <div style="background: white; border: 1px solid #fef3c7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">ğŸ’°</span>
          <span style="font-size: 0.875rem; font-weight: 700; color: #d97706;" id="videoAwaitingPaymentCount">0 Awaiting</span>
        </div>
        <div style="background: white; border: 1px solid #dcfce7; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.375rem; white-space: nowrap;">
          <span style="font-size: 0.6875rem; color: #6b7280; font-weight: 600;">ğŸ§¾</span>
          <span style="font-size: 0.875rem; font-weight: 700; color: #16a34a;" id="videoReadyInvoiceCount">0 Ready</span>
        </div>
      </div>
      
      <div class="section-body video-body" id="videoBody" style="padding: 1.5rem; display: none;">
        <!-- Filter Tabs -->
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
          <select id="videoPaymentFilter" class="form-input" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border: 1px solid #e2e8f0; border-radius: 6px; min-width: 180px;" onchange="filterVideoConsultationsList()">
            <option value="all">ğŸ“‹ All Video Consultations</option>
            <option value="queue">ğŸ“‹ Video Queue (Not Seen)</option>
            <option value="awaiting">ğŸ’° Awaiting Payment</option>
            <option value="ready">ğŸ§¾ Ready for Invoice</option>
          </select>
          <div style="flex: 1;"></div>
          <div style="font-size: 0.75rem; color: #64748b; display: flex; align-items: center;">
            <span>ğŸ’¡ Mark payment before or after video call. Invoice generates when both paid & seen.</span>
          </div>
        </div>
        
        <!-- Video Consultations List -->
        <div id="videoConsultationsDetailList" style="min-height: 100px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
          <div style="text-align: center; padding: 2rem; color: #64748b;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
            <div>Loading consultations...</div>
          </div>
        </div>
        
        <!-- Doctor Overview (Collapsed by default) -->
        <details style="margin-top: 1.5rem;">
          <summary style="cursor: pointer; font-weight: 600; color: #1e293b; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            ğŸ‘¨â€âš•ï¸ Doctor Video Stats Overview
          </summary>
          <div id="doctorVideoList" style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
            <div style="text-align: center; padding: 2rem; color: #64748b;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
              <div>Loading doctor stats...</div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Booking QR Code Section -->
    <div class="section qr-section" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div class="section-header clickable qr-header" onclick="toggleQRSection()" style="background: #fde68a; color: #92400e; padding: 1rem; border-radius: 12px 12px 0 0; border-bottom: 1px solid #fcd34d; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 class="section-title qr-title" style="font-size: 1.125rem; margin: 0;">ğŸ“± Clinic Booking QR Code</h2>
        <span class="collapse-icon" id="qrIcon" style="font-size: 1.25rem; transition: transform 0.3s ease; transform: rotate(-90deg);">â–¼</span>
      </div>
      <div class="section-body qr-body" id="qrBody" style="padding: 1rem; display: none;">
        <div class="qr-content" style="display: flex; flex-direction: column; align-items: center; gap: 1rem; text-align: center;">
          <!-- Description -->
          <p class="qr-description" style="color: var(--text-muted); margin: 0; font-size: 0.875rem; line-height: 1.5;">
            ğŸ“‹ Patients scan this to book appointments<br>
            ğŸ–¨ï¸ Print and display at reception
          </p>
          
          <!-- QR Code Display -->
          <div id="qrCodeContainer" class="qr-container" style="padding: 0.75rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div id="qrCodeImage" class="qr-image" style="min-height: 150px; min-width: 150px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
              <span style="font-size: 0.75rem;">â³ Loading...</span>
            </div>
          </div>
          
          <!-- Booking Link Display -->
          <div id="bookingLinkDisplay" style="display: none; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb; width: 100%; max-width: 400px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; font-weight: 600;">Booking URL:</div>
            <div id="bookingLinkText" style="font-size: 0.8125rem; color: #1e293b; word-break: break-all; font-family: monospace;"></div>
          </div>
          
          <!-- Actions -->
          <div class="qr-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
            <button onclick="downloadQRCode()" class="btn btn-primary btn-sm" id="downloadQRBtn" style="display: none;">
              ğŸ“¥ Download
            </button>
            <button onclick="copyBookingLink()" class="btn btn-outline btn-sm" id="copyLinkBtn" style="display: none;">
              ğŸ”— Copy Link
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Manage Profile Modal -->
  <div id="manageProfileModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeManageProfileModal" aria-label="Close">âœ•</button>
      <h3>Manage Profile</h3>
      
      <div class="tabs">
        <button class="tab active" data-tab="profile">Profile Details</button>
        <button class="tab" data-tab="password">Change Password</button>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content active" id="profileTab">
        <form id="updateProfileForm">
          <div class="form-row">
            <div class="form-group">
              <label>Clinic Name *</label>
              <input type="text" id="editName" required />
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" id="editPhone" required maxlength="10" pattern="[0-9]{10}" inputmode="numeric" title="Please enter exactly 10 digits" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="editEmail" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" title="Please enter a valid email" />
          </div>

          <div class="form-group">
            <label>Address *</label>
            <input type="text" id="editAddress" required />
          </div>
          
          <div class="form-group">
            <label>UPI ID</label>
            <input type="text" id="editUpi" placeholder="Optional" />
          </div>

          <div class="form-group">
            <label>Clinic Logo</label>
            <input type="file" id="editLogo" accept="image/png,image/jpeg,image/jpg" />
            <small style="color: var(--text-muted); font-size: 0.8125rem;">Upload clinic logo (appears on prescriptions)</small>
          </div>

          <div class="form-group">
            <label>QR Code (Payment)</label>
            <input type="file" id="editQrCode" accept="image/png,image/jpeg" />
            <small style="color: var(--text-muted); font-size: 0.8125rem;">Upload a new QR code for payments (optional)</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-success" style="flex:1;">Save Changes</button>
            <button type="button" class="btn btn-outline" onclick="loadClinicInfo()" style="flex:1;">Reset</button>
          </div>
        </form>
      </div>

      <!-- Password Tab -->
      <div class="tab-content" id="passwordTab">
        <form id="changePasswordForm">
          <div class="form-group">
            <label>Current Password *</label>
            <input type="password" id="currentPassword" autocomplete="current-password" required minlength="6" />
          </div>
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" id="newPassword" autocomplete="new-password" required minlength="6" />
            <small style="color: var(--text-muted); font-size: 0.8125rem;">Minimum 6 characters</small>
          </div>
          <div class="form-group">
            <label>Confirm New Password *</label>
            <input type="password" id="confirmPassword" autocomplete="new-password" required />
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success" style="flex:1;">Update Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <div class="toast-icon" id="toastIcon">âœ“</div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Success</div>
      <div class="toast-message" id="toastMessage">Action completed successfully</div>
    </div>
    <button class="toast-close" onclick="hideToast()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M12 4L4 12M4 4l8 8"/>
      </svg>
    </button>
  </div>

  <script>
    // Toast notification system
    function showToast(title, message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastIcon = document.getElementById('toastIcon');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      toast.classList.remove('toast-success', 'toast-error', 'toast-warning', 'hiding');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      
      toast.classList.add(`toast-${type}`);
      if (type === 'success') {
        toastIcon.textContent = 'âœ“';
      } else if (type === 'error') {
        toastIcon.textContent = 'âœ•';
      } else if (type === 'warning') {
        toastIcon.textContent = 'âš ';
      }
      
      toast.classList.add('show');
      setTimeout(() => hideToast(), 5000);
    }
    
    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.add('hiding');
      setTimeout(() => {
        toast.classList.remove('show', 'hiding');
      }, 300);
    }

    // Load clinic info
    async function loadClinicInfo() {
      const clinicId = sessionStorage.getItem('clinic_id');
      if (clinicId) {
        document.getElementById('welcomeLocation').textContent = sessionStorage.getItem('clinic_address') || 'Your Clinic';
      }
      
      try {
        const res = await fetch('/clinic/profile');
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data.success && data.clinic) {
          const clinic = data.clinic;
          document.getElementById('headerClinicName').textContent = clinic.name || 'Clinic';
          
          if (clinic.address) {
            document.getElementById('headerClinicAddress').textContent = clinic.address;
          }
          
          // Handle clinic logo in header
          const headerLogo = document.getElementById('headerClinicLogo');
          if (clinic.logo_path) {
            headerLogo.src = clinic.logo_path;
            headerLogo.style.display = 'block';
          } else {
            headerLogo.style.display = 'none';
          }
          
          document.getElementById('editName').value = clinic.name || '';
          document.getElementById('editPhone').value = clinic.phone || '';
          document.getElementById('editAddress').value = clinic.address || '';
          document.getElementById('editEmail').value = clinic.email || '';
          document.getElementById('editUpi').value = clinic.upi_id || '';
          
          // Check if profile is incomplete (missing payment info)
          checkProfileCompletion(clinic);
        } else {
          console.error('Invalid response format');
          document.getElementById('headerClinicName').textContent = 'Clinic';
          document.getElementById('headerClinicLogo').style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to load profile:', err.message);
        const address = sessionStorage.getItem('clinic_address');
        if (address) {
          document.getElementById('welcomeLocation').textContent = address;
        }
      }
    }

    // Check if profile is complete and show reminder
    function checkProfileCompletion(clinic) {
      const isProfileIncomplete = !clinic.upi_id && !clinic.qr_code_path;
      
      // Check if we've already shown the reminder in this session
      const reminderShown = sessionStorage.getItem('profile_reminder_shown');
      
      if (isProfileIncomplete && !reminderShown) {
        // Show reminder modal after a short delay
        setTimeout(() => {
          showProfileCompletionReminder();
          sessionStorage.setItem('profile_reminder_shown', 'true');
        }, 1000);
      }
    }

    // Show profile completion reminder modal
    function showProfileCompletionReminder() {
      const modalHTML = `
        <div id="profileReminderModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 1rem;">
          <div style="background: white; border-radius: 12px; max-width: 450px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease-out;">
            <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="font-size: 2rem;">ğŸ’¡</div>
                <div>
                  <h3 style="font-size: 1.125rem; font-weight: 700; color: #1e293b; margin: 0;">Complete Your Payment Setup</h3>
                  <p style="font-size: 0.875rem; color: #64748b; margin: 0.25rem 0 0 0;">Receive payments from patients easily</p>
                </div>
              </div>
            </div>
            
            <div style="padding: 1.5rem;">
              <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <p style="font-size: 0.875rem; color: #92400e; margin: 0; line-height: 1.5;">
                  <strong>âš ï¸ Missing Payment Details</strong><br>
                  Add your UPI ID & QR code to enable online payments from patients.
                </p>
              </div>
              
              <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 1.5rem; line-height: 1.6;">
                <p style="margin: 0 0 0.5rem 0;">To start receiving payments, please add:</p>
                <ul style="margin: 0; padding-left: 1.25rem;">
                  <li>ğŸ’³ UPI ID (e.g., yourname@paytm)</li>
                  <li>ğŸ“± Payment QR Code image</li>
                </ul>
              </div>
              
              <div style="display: flex; gap: 0.75rem;">
                <button onclick="document.getElementById('profileReminderModal').remove()" style="flex: 1; background: white; color: #64748b; border: 1px solid #cbd5e1; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                  Later
                </button>
                <button onclick="document.getElementById('profileReminderModal').remove(); document.getElementById('manageProfileBtn').click()" style="flex: 1; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: none; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                  Complete Now â†’
                </button>
              </div>
            </div>
          </div>
        </div>
        <style>
          @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
        </style>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Modal handlers
    document.getElementById('manageProfileBtn').addEventListener('click', () => {
      document.getElementById('manageProfileModal').classList.add('active');
      switchTab('profile');
    });

    document.getElementById('closeManageProfileModal').addEventListener('click', () => {
      document.getElementById('manageProfileModal').classList.remove('active');
      document.getElementById('changePasswordForm').reset();
    });

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Close modals on backdrop click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    // Update profile form
    document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('editName').value.trim();
      const phone = document.getElementById('editPhone').value.trim();
      const address = document.getElementById('editAddress').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const upi_id = document.getElementById('editUpi').value.trim();
      const qrCodeFile = document.getElementById('editQrCode').files[0];
      const logoFile = document.getElementById('editLogo').files[0];

      if (!name || !phone || !email || !address) {
        showToast('Missing Fields', 'Please fill all required fields (Name, Phone, Email, Address)', 'warning');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('phone', phone);
        formData.append('address', address);
        formData.append('email', email);
        formData.append('upi_id', upi_id);
        if (qrCodeFile) {
          formData.append('qr_image', qrCodeFile);
        }
        if (logoFile) {
          formData.append('logo', logoFile);
        }

        const res = await fetch('/clinic/update-profile', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await res.json();

        if (data.success) {
          showToast('Profile Updated', 'Your clinic profile has been updated successfully', 'success');
          loadClinicInfo();
          document.getElementById('manageProfileModal').classList.remove('active');
        } else {
          showToast('Update Failed', data.message || 'Failed to update profile', 'error');
        }
      } catch (err) {
        console.error('Profile update error:', err);
        showToast('Error', err.message || 'Error updating profile. Please try again.', 'error');
      }
    });

    // Change password form
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (newPass !== confirm) {
        showToast('Password Mismatch', 'New passwords do not match', 'warning');
        return;
      }

      try {
        const res = await fetch('/clinics/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword: current, newPassword: newPass })
        });
        const data = await res.json();

        if (data.success) {
          showToast('Password Updated', 'Your password has been changed successfully', 'success');
          document.getElementById('manageProfileModal').classList.remove('active');
          document.getElementById('changePasswordForm').reset();
        } else {
          showToast('Update Failed', data.message || 'Failed to update password', 'error');
        }
      } catch (err) {
        showToast('Error', 'Error updating password. Please try again.', 'error');
      }
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        await fetch('/clinics/logout', { method: 'POST' });
      } catch (err) {}
      sessionStorage.clear();
      window.location.href = '/clinic_login.html';
    });

    // Initialize
    loadClinicInfo();
    loadStats();
    loadBookingQRCode();
    loadAppointments();

    // Global variables for appointments
    let allAppointments = [];
    let selectedDate = null; // null means "today", empty string means "all dates"
    let selectedDoctor = '';

    // Load appointments function
    async function loadAppointments() {
      try {
        const sessionRes = await fetch('/clinic/session');
        const sessionData = await sessionRes.json();
        
        if (!sessionData.success || !sessionData.clinic || !sessionData.clinic.clinic_id) {
          document.getElementById('loadingAppointments').textContent = 'Please log in to view appointments';
          return;
        }
        
        const clinicId = sessionData.clinic.clinic_id;
        
        const bookingsRes = await fetch(`/bookings/clinic/${clinicId}`);
        const bookingsData = await bookingsRes.json();
        
        if (bookingsData.success && bookingsData.bookings) {
          allAppointments = bookingsData.bookings;
          
          // Populate doctor dropdown
          const doctors = [...new Set(allAppointments.map(a => a.doctor_name).filter(Boolean))];
          const doctorSelect = document.getElementById('doctorFilter');
          doctorSelect.innerHTML = '<option value="">All Doctors</option>' + 
            doctors.map(d => `<option value="${d}">${d}</option>`).join('');
          
          // Set today's date in date picker
          const today = new Date();
          const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
          document.getElementById('dateFilter').value = todayStr;
          selectedDate = todayStr;
          
          document.getElementById('loadingAppointments').style.display = 'none';
          document.getElementById('appointmentFilters').style.display = 'block';
          document.getElementById('appointmentsTable').style.display = 'block';
          updateHeading();
          applyFilters();
        } else {
          document.getElementById('loadingAppointments').textContent = 'No appointments found';
        }
      } catch (error) {
        console.error('Error loading appointments:', error);
        document.getElementById('loadingAppointments').textContent = 'Error loading appointments';
      }
    }

    // Select date from picker
    function selectDate() {
      selectedDate = document.getElementById('dateFilter').value;
      document.querySelector('.filter-btn')?.classList.remove('active');
      updateHeading();
      applyFilters();
    }

    // Select all dates
    function selectAllDates() {
      selectedDate = '';
      document.getElementById('dateFilter').value = '';
      document.querySelector('.filter-btn')?.classList.add('active');
      updateHeading();
      applyFilters();
    }

    // Invoice date filter functions
    function setInvoiceDateRange(range) {
      const today = new Date();
      const startDateEl = document.getElementById('invoiceStartDate');
      const endDateEl = document.getElementById('invoiceEndDate');
      
      const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      const todayStr = formatDate(today);
      
      switch(range) {
        case 'today':
          startDateEl.value = todayStr;
          endDateEl.value = todayStr;
          break;
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - 6);
          startDateEl.value = formatDate(weekStart);
          endDateEl.value = todayStr;
          break;
        case 'month':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          startDateEl.value = formatDate(monthStart);
          endDateEl.value = todayStr;
          break;
        case 'all':
          startDateEl.value = '';
          endDateEl.value = '';
          break;
      }
      loadAllInvoices();
    }

    // Update heading based on filter
    function updateHeading() {
      const heading = document.getElementById('appointmentsHeading');
      if (!heading) return;
      
      if (!selectedDate || selectedDate === '') {
        heading.textContent = 'All Appointments';
      } else {
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        if (selectedDate === todayStr) {
          heading.textContent = "Today's Appointments";
        } else {
          // Format date nicely
          const dateObj = new Date(selectedDate + 'T00:00:00');
          const options = { day: 'numeric', month: 'short', year: 'numeric' };
          const formattedDate = dateObj.toLocaleDateString('en-GB', options);
          heading.textContent = `Appointments for ${formattedDate}`;
        }
      }
    }

    // Toggle appointments section
    // Refresh appointments with spinning animation
    async function refreshAppointmentsWithSpin() {
      const btn = document.getElementById('appointmentsRefreshBtn');
      if (btn) btn.classList.add('loading');
      try {
        await loadAppointments();
      } catch (error) {
        console.error('Error refreshing appointments:', error);
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Refresh billing stats with spinning animation
    async function refreshBillingStats() {
      const btn = document.getElementById('billingRefreshBtn');
      if (btn) btn.classList.add('loading');
      try {
        await loadInvoiceStats();
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Refresh checkouts with spinning animation
    async function refreshCheckouts() {
      const btn = document.getElementById('checkoutsRefreshBtn');
      if (btn) btn.classList.add('loading');
      try {
        await loadTodaysCheckouts();
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Refresh invoices with spinning animation
    async function refreshInvoices() {
      const btn = document.getElementById('invoicesRefreshBtn');
      if (btn) btn.classList.add('loading');
      try {
        await loadAllInvoices();
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Refresh video stats with spinning animation
    async function refreshVideoStats() {
      const btn = document.getElementById('videoRefreshBtn');
      if (btn) btn.classList.add('loading');
      try {
        await loadVideoConsultationsOverview();
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Apply date, doctor, and mode filters
    function applyFilters() {
      selectedDoctor = document.getElementById('doctorFilter')?.value || '';
      const selectedMode = document.getElementById('modeFilter')?.value || '';
      
      let filtered = allAppointments;
      
      // Filter by date
      if (selectedDate) {
        filtered = filtered.filter(a => a.appointment_date === selectedDate);
        console.log(`Filtering for specific date: ${selectedDate}`);
      } else if (selectedDate !== '') {
        // selectedDate is null, means all dates
        console.log('Showing all dates');
      }
      
      // Filter by doctor
      if (selectedDoctor) {
        filtered = filtered.filter(a => a.doctor_name === selectedDoctor);
      }
      
      // Filter by mode (video/clinic)
      if (selectedMode === 'video') {
        filtered = filtered.filter(a => a.is_video_consultation === 1 || a.is_video_consultation === true);
      } else if (selectedMode === 'clinic') {
        filtered = filtered.filter(a => a.is_video_consultation !== 1 && a.is_video_consultation !== true);
      }
      
      // Sort by appointment date and time
      filtered.sort((a, b) => {
        const dateCompare = (a.appointment_date || '').localeCompare(b.appointment_date || '');
        if (dateCompare !== 0) return dateCompare;
        return (a.appointment_time || '').localeCompare(b.appointment_time || '');
      });
      
      console.log(`Filtered ${filtered.length} appointments${selectedDate ? ' for date: ' + selectedDate : ' (all dates)'}${selectedDoctor ? ' - Doctor: ' + selectedDoctor : ''}${selectedMode ? ' - Mode: ' + selectedMode : ''}`);
      
      renderAppointmentsTable(filtered);
    }

    // Render appointments table
    function renderAppointmentsTable(appointments) {
      const tbody = document.getElementById('appointmentsTableBody');
      
      if (!appointments || appointments.length === 0) {
        const dateMsg = selectedDate ? `for ${selectedDate}` : 'for selected filters';
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
              No appointments found ${dateMsg}
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = appointments.map((apt, index) => {
        const statusColors = {
          'pending': '#f59e0b',
          'not_seen': '#f59e0b',
          'seen': '#10b981',
          'completed': '#10b981',
          'cancelled': '#ef4444',
          'no_show': '#ef4444'
        };
        const statusColor = statusColors[apt.consult_status] || '#64748b';
        const statusText = (apt.consult_status || 'pending').replace('_', ' ');
        
        // Consultation mode - Video Call or In-Clinic
        const isVideoCall = apt.is_video_consultation === 1 || apt.is_video_consultation === true;
        const modeIcon = isVideoCall ? 'ğŸ“¹' : 'ğŸ¥';
        const modeText = isVideoCall ? 'Video' : 'Clinic';
        const modeBg = isVideoCall ? '#dcfce7' : '#dbeafe';
        const modeColor = isVideoCall ? '#16a34a' : '#2563eb';
        
        // Alternating row colors
        const bgColor = index % 2 === 0 ? 'white' : '#f8fafc';
        
        // Format date nicely
        const aptDate = apt.appointment_date ? new Date(apt.appointment_date + 'T00:00:00').toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : '-';
        const aptTime = apt.appointment_time || '-';
        
        return `
          <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 0.75rem;">
              <div style="font-size: 0.8125rem; font-family: monospace; color: #3b82f6;">${apt.appointment_id || '-'}</div>
            </td>
            <td style="padding: 0.75rem; text-align: center;">
              <span style="background: #e0e7ff; color: #4f46e5; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.875rem; font-weight: 700;">#${apt.queue_number || '-'}</span>
            </td>
            <td style="padding: 0.75rem;">
              <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${apt.patient_name || '-'}</div>
              <div style="font-size: 0.75rem; color: #64748b; font-family: monospace;">${apt.patient_mobile || ''}</div>
            </td>
            <td style="padding: 0.75rem; font-size: 0.875rem; color: #475569; font-weight: 500;">${apt.doctor_name || '-'}</td>
            <td style="padding: 0.75rem; text-align: center;">
              <div style="font-weight: 600; color: #1e293b; font-size: 0.8125rem;">${aptDate}</div>
              <div style="color: #64748b; font-size: 0.75rem;">${aptTime}</div>
            </td>
            <td style="padding: 0.75rem; text-align: center;">
              <span style="background: ${modeBg}; color: ${modeColor}; padding: 0.125rem 0.25rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.25rem;">${modeIcon}</span><span style="background: ${statusColor}22; color: ${statusColor}; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize;">${statusText}</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Load stats function
    async function loadStats() {
      try {
        console.log('[loadStats] Starting...');
        const sessionRes = await fetch('/clinic/session');
        const sessionData = await sessionRes.json();
        console.log('[loadStats] Session data:', sessionData);
        
        if (!sessionData.success || !sessionData.clinic || !sessionData.clinic.clinic_id) {
          console.log('[loadStats] No clinic session found');
          return;
        }
        
        const clinicId = sessionData.clinic.clinic_id;
        console.log('[loadStats] Clinic ID:', clinicId);
        
        // Load doctors count
        const doctorsRes = await fetch(`/doctors/by-clinic/${clinicId}`);
        const doctorsData = await doctorsRes.json();
        const doctors = doctorsData.doctors || [];
        console.log('[loadStats] Doctors:', doctors.length);
        
        document.getElementById('totalDoctors').textContent = doctors.length;
        
        // Load today's active doctors (doctors with availability slots today)
        const activeDoctorsToday = doctors.filter(doc => doc.is_active === 1).length;
        console.log('[loadStats] Active today:', activeDoctorsToday);
        document.getElementById('activeToday').textContent = activeDoctorsToday;
        
        // Load total appointments for this clinic
        const bookingsRes = await fetch(`/bookings/clinic/${clinicId}`);
        const bookingsData = await bookingsRes.json();
        const appointments = bookingsData.bookings || [];
        console.log('[loadStats] Appointments:', appointments.length);
        
        document.getElementById('totalAppointments').textContent = appointments.length;
        console.log('[loadStats] Stats loaded successfully!');
      } catch (error) {
        console.error('[loadStats] Error loading stats:', error);
        // Set to 0 on error
        document.getElementById('totalDoctors').textContent = '0';
        document.getElementById('activeToday').textContent = '0';
        document.getElementById('totalAppointments').textContent = '0';
      }
    }

    // QR Code Functions
    let currentQRData = null;

    async function loadBookingQRCode() {
      try {
        const sessionRes = await fetch('/clinic/session');
        const sessionData = await sessionRes.json();
        
        if (!sessionData.success || !sessionData.clinic || !sessionData.clinic.clinic_id) {
          document.getElementById('qrCodeImage').innerHTML = '<span style="color: var(--danger);">âŒ Please log in to view QR code</span>';
          return;
        }

        const clinicId = sessionData.clinic.clinic_id;
        const res = await fetch(`/clinic/generate-qr/${clinicId}`);
        const data = await res.json();
        
        if (data.success) {
          currentQRData = data;
          
          // Display QR code image (smaller on page)
          document.getElementById('qrCodeImage').innerHTML = `
            <div style="display: inline-block; text-align: center;">
              <div style="margin-bottom: 6px; font-size: 0.7rem; color: #64748b; font-weight: 600; text-transform: capitalize; letter-spacing: 0.5px;">Scan for Booking</div>
              <img src="${data.qrCode}" 
                   alt="Booking QR Code" 
                   style="width: 180px; height: 180px; border: 2px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: block;" />
              <div style="margin-top: 6px; font-size: 0.75rem; color: #1e293b; font-weight: 700;">${data.clinic_name}</div>
            </div>
          `;
          
          // Show buttons
          document.getElementById('downloadQRBtn').style.display = 'inline-flex';
          document.getElementById('copyLinkBtn').style.display = 'inline-flex';
          
          // Display booking link
          document.getElementById('bookingLinkText').textContent = data.bookingUrl;
          document.getElementById('bookingLinkDisplay').style.display = 'block';
          
        } else {
          document.getElementById('qrCodeImage').innerHTML = `
            <div style="color: var(--danger); padding: 2rem; text-align: center;">
              <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">âŒ</p>
              <p style="font-weight: 600;">Failed to generate QR code</p>
              <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-muted);">${data.message || 'Unknown error'}</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading QR code:', error);
        document.getElementById('qrCodeImage').innerHTML = `
          <div style="color: var(--danger); padding: 2rem; text-align: center;">
            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">âŒ</p>
            <p style="font-weight: 600;">Error loading QR code</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-muted);">${error.message}</p>
          </div>
        `;
      }
    }

    function downloadQRCode() {
      if (!currentQRData || !currentQRData.qrCode) {
        showToast('Error', 'QR code not available', 'error');
        return;
      }

      // Create a canvas to generate full-size QR code for download
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const qrSize = 600;
      const topTextHeight = 50;
      const bottomTextHeight = 60;
      canvas.width = qrSize;
      canvas.height = topTextHeight + qrSize + bottomTextHeight;

      const img = new Image();
      img.onload = function() {
        // Fill white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Add text on top
        ctx.fillStyle = '#64748b';
        ctx.font = '600 28px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Scan for booking', qrSize / 2, 35);
        
        // Draw QR code in middle
        ctx.drawImage(img, 0, topTextHeight, qrSize, qrSize);
        
        // Add clinic name at bottom
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 36px Arial';
        ctx.fillText(currentQRData.clinic_name || 'Clinic', qrSize / 2, topTextHeight + qrSize + 48);
        
        // Download
        canvas.toBlob(function(blob) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${currentQRData.clinic_name || 'clinic'}_booking_qr.png`;
          link.click();
          URL.revokeObjectURL(link.href);
          showToast('Success', 'QR code downloaded successfully!', 'success');
        });
      };
      img.src = currentQRData.qrCode;
    }

    function copyBookingLink() {
      if (!currentQRData || !currentQRData.bookingUrl) {
        showToast('Error', 'Booking link not available', 'error');
        return;
      }

      // Copy to clipboard
      navigator.clipboard.writeText(currentQRData.bookingUrl).then(() => {
        showToast('Copied!', 'Booking link copied to clipboard', 'success');
      }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentQRData.bookingUrl;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Copied!', 'Booking link copied to clipboard', 'success');
        } catch (err) {
          showToast('Error', 'Failed to copy link', 'error');
        }
        document.body.removeChild(textArea);
      });
    }

    // ============= BILLING & INVOICE FUNCTIONS =============
    let currentClinicId = null;

    // Initialize billing section
    function initializeBillingSection() {
      // Set today's date in invoice date filters by default
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      document.getElementById('invoiceStartDate').value = todayStr;
      document.getElementById('invoiceEndDate').value = todayStr;
      
      // Try to get clinic ID from session
      fetch('/clinic/session')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.clinic && data.clinic.clinic_id) {
            currentClinicId = data.clinic.clinic_id;
            loadInvoiceStats();
            loadTodaysCheckouts();
            loadAllInvoices();
          }
        })
        .catch(err => console.error('Session check error:', err));
    }

    // Load invoice statistics
    async function loadInvoiceStats() {
      if (!currentClinicId) return;
      
      try {
        const res = await fetch(`/api/invoices/clinic/${currentClinicId}/stats`);
        const data = await res.json();
        
        if (data.success && data.stats) {
          const stats = data.stats;
          
          document.getElementById('statTodayRevenue').textContent = `â‚¹${stats.today_revenue.toFixed(2)}`;
          document.getElementById('statPendingPayments').textContent = `â‚¹${stats.pending_payments.toFixed(2)}`;
          document.getElementById('statMonthRevenue').textContent = `â‚¹${stats.month_revenue.toFixed(2)}`;
          document.getElementById('statTodayCheckouts').textContent = stats.today_checkouts;
          
          const todayInvoices = await getTodayInvoiceCount();
          const unpaidCount = await getUnpaidInvoiceCount();
          
          document.getElementById('statTodayInvoices').textContent = `${todayInvoices} invoice${todayInvoices !== 1 ? 's' : ''}`;
          document.getElementById('statPendingCount').textContent = `${unpaidCount} unpaid`;
        }
      } catch (error) {
        console.error('Load stats error:', error);
      }
    }

    async function getTodayInvoiceCount() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`/api/invoices/clinic/${currentClinicId}/all?start_date=${today}&end_date=${today}`);
        const data = await res.json();
        return data.success ? data.invoices.length : 0;
      } catch { return 0; }
    }

    async function getUnpaidInvoiceCount() {
      try {
        const res = await fetch(`/api/invoices/clinic/${currentClinicId}/all?status=unpaid`);
        const data = await res.json();
        return data.success ? data.invoices.length : 0;
      } catch { return 0; }
    }

    // Load today's checkouts
    async function loadTodaysCheckouts() {
      if (!currentClinicId) return;
      
      const container = document.getElementById('todaysCheckoutsList');
      
      try {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div><div>Loading...</div></div>';
        
        const res = await fetch(`/api/invoices/clinic/${currentClinicId}/checkouts`);
        const data = await res.json();
        
        if (data.success && data.checkouts) {
          if (data.checkouts.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #10b981;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ‰</div><div>All checkouts completed for today!</div></div>';
            return;
          }
          
          let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
          
          data.checkouts.forEach(visit => {
            // Safely parse visit time - check multiple possible field names
            let visitTime = 'N/A';
            try {
              const dateField = visit.visit_time || visit.visit_date || visit.created_at;
              if (dateField) {
                const dateObj = new Date(dateField);
                if (!isNaN(dateObj.getTime())) {
                  visitTime = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                }
              }
            } catch (e) {
              console.error('Date parsing error:', e);
            }
            
            html += `
              <div class="checkout-card" style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                <div class="checkout-info" style="flex: 1;">
                  <div class="checkout-patient" style="font-weight: 600; color: #1e293b; font-size: 1rem;">${visit.patient_name || 'Unknown Patient'}</div>
                  <div class="checkout-details" style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem;">
                    ğŸ“± ${visit.patient_mobile || 'N/A'} â€¢ ğŸ‘¨â€âš•ï¸ ${visit.doctor_name || 'Unknown'} â€¢ ğŸ• ${visitTime}
                  </div>
                  <div class="checkout-fee" style="color: #10b981; font-weight: 600; font-size: 0.875rem; margin-top: 0.5rem;">â‚¹${visit.consultation_fee || 0} consultation</div>
                </div>
                <button class="btn btn-success checkout-btn" onclick="openInvoiceModal('${visit.visit_id}', '${visit.patient_name || ''}', '${visit.patient_mobile || ''}', '${visit.doctor_name || ''}', ${visit.consultation_fee || 0}, '${visit.pres_path || ''}')" style="white-space: nowrap;">
                  ğŸ§¾ Checkout
                </button>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No checkouts pending</div>';
        }
      } catch (error) {
        console.error('Load checkouts error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading checkouts</div>';
      }
    }

    // Load all invoices
    async function loadAllInvoices() {
      if (!currentClinicId) return;
      
      const container = document.getElementById('allInvoicesList');
      const status = document.getElementById('invoiceStatusFilter').value;
      const modeFilter = document.getElementById('invoiceModeFilter').value;
      const startDate = document.getElementById('invoiceStartDate').value;
      const endDate = document.getElementById('invoiceEndDate').value;
      const patientSearch = document.getElementById('invoicePatientSearch').value;
      
      try {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div><div>Loading invoices...</div></div>';
        
        const params = new URLSearchParams();
        if (status !== 'all') params.append('status', status);
        if (modeFilter !== 'all') params.append('mode', modeFilter);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (patientSearch) params.append('patient_search', patientSearch);
        
        const res = await fetch(`/api/invoices/clinic/${currentClinicId}/all?${params.toString()}`);
        const data = await res.json();
        
        if (data.success && data.invoices) {
          if (data.invoices.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No invoices found</div>';
            return;
          }
          
          let html = '<div class="invoice-table-wrapper" style="overflow-x: auto;"><table class="invoice-table" style="width: 100%; border-collapse: collapse;">';
          html += `
            <thead>
              <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                <th class="inv-col-id" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ§¾ Invoice</th>
                <th class="inv-col-patient" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ‘¤ Patient</th>
                <th class="inv-col-doctor" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ‘¨â€âš•ï¸ Doctor</th>
                <th class="inv-col-amount" style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ’° Payment</th>
                <th class="inv-col-date" style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ“… Date</th>
                <th class="inv-col-actions" style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">âš¡ Actions</th>
              </tr>
            </thead>
            <tbody>
          `;
          
          data.invoices.forEach((inv, index) => {
            const isPaid = inv.payment_status === 'paid';
            const statusBadge = isPaid 
              ? '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">âœ“ PAID</span>'
              : '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">UNPAID</span>';
            
            const invoiceDateTime = new Date(inv.created_at);
            const invoiceDate = invoiceDateTime.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
            const invoiceTime = invoiceDateTime.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            const bgColor = index % 2 === 0 ? 'white' : '#f8fafc';
            
            // Determine consultation mode
            const isVideo = inv.is_video_consultation === 1 || inv.is_video_consultation === true;
            const modeIcon = isVideo ? 'ğŸ“¹' : 'ğŸ¥';
            const modeText = isVideo ? 'Video' : 'Clinic';
            const modeBg = isVideo ? '#dcfce7' : '#dbeafe';
            const modeColor = isVideo ? '#16a34a' : '#2563eb';
            
            html += `
              <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 0.75rem;">
                  <div style="font-size: 0.8125rem; font-family: monospace; color: #3b82f6;">${inv.invoice_id}</div>
                  <span style="background: ${modeBg}; color: ${modeColor}; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.625rem; font-weight: 600; margin-top: 0.25rem; display: inline-block;">${modeIcon} ${modeText}</span>
                </td>
                <td style="padding: 0.75rem;">
                  <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${inv.patient_name || 'Unknown'}</div>
                  <div style="color: #64748b; font-size: 0.75rem; font-family: monospace;">${inv.patient_mobile || 'N/A'}</div>
                </td>
                <td style="padding: 0.75rem; font-size: 0.875rem; color: #475569; font-weight: 500;">${inv.doctor_name || 'Unknown'}</td>
                <td style="padding: 0.75rem; white-space: nowrap;">
                  <span style="font-weight: 700; color: ${isPaid ? '#16a34a' : '#0369a1'}; font-size: 0.9375rem;">â‚¹${parseFloat(inv.total_amount).toFixed(0)}</span>
                  <span style="margin-left: 0.5rem;">${statusBadge}</span>
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                  <div style="font-weight: 600; color: #1e293b; font-size: 0.8125rem;">${invoiceDate}</div>
                  <div style="color: #64748b; font-size: 0.75rem;">${invoiceTime}</div>
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                  <div style="display: flex; gap: 0.375rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="printInvoice('${inv.invoice_path}')" class="btn btn-sm" style="background: #f3e8ff; color: #7c3aed; border: none; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" title="Print">
                      ğŸ–¨ï¸ Print
                    </button>
                    <button onclick="sendInvoiceWhatsApp('${inv.invoice_id}')" class="btn btn-sm" style="background: #dcfce7; color: #16a34a; border: none; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" title="Send via WhatsApp">
                      ğŸ’¬ WhatsApp
                    </button>
                    ${inv.payment_status === 'unpaid' ? `
                      <button class="btn btn-sm" onclick="markAsPaid('${inv.invoice_id}')" style="background: #dbeafe; color: #1d4ed8; border: none; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" title="Mark as Paid">ğŸ’µ Mark Paid</button>
                    ` : `
                      <button class="btn btn-sm" style="background: #dcfce7; color: #16a34a; cursor: not-allowed; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" disabled title="Already Paid">âœ“ Paid</button>
                    `}
                  </div>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No invoices found</div>';
        }
      } catch (error) {
        console.error('Load invoices error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading invoices</div>';
      }
    }

    // Mark invoice as paid
    async function markAsPaid(invoiceId) {
      // Custom confirmation using showToast-style approach
      const confirmed = await new Promise((resolve) => {
        const confirmMsg = document.createElement('div');
        confirmMsg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          z-index: 10000;
          text-align: center;
          min-width: 320px;
        `;
        
        confirmMsg.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’°</div>
          <h3 style="margin-bottom: 0.5rem; font-size: 1.25rem; color: #0c4a6e;">Mark Invoice as Paid?</h3>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">This will mark the invoice as paid.</p>
          <div style="display: flex; gap: 0.75rem; justify-content: center;">
            <button id="confirmNo" style="padding: 0.625rem 1.5rem; border: 1px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
            <button id="confirmYes" style="padding: 0.625rem 1.5rem; border: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Confirm</button>
          </div>
        `;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(confirmMsg);
        
        confirmMsg.querySelector('#confirmYes').onclick = () => {
          document.body.removeChild(confirmMsg);
          document.body.removeChild(overlay);
          resolve(true);
        };
        
        confirmMsg.querySelector('#confirmNo').onclick = () => {
          document.body.removeChild(confirmMsg);
          document.body.removeChild(overlay);
          resolve(false);
        };
        
        overlay.onclick = () => {
          document.body.removeChild(confirmMsg);
          document.body.removeChild(overlay);
          resolve(false);
        };
      });
      
      if (!confirmed) return;
      
      // Custom payment method selector
      const paymentMethod = await new Promise((resolve) => {
        const methodMsg = document.createElement('div');
        methodMsg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 2rem;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          z-index: 10000;
          text-align: center;
          min-width: 360px;
        `;
        
        methodMsg.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’³</div>
          <h3 style="margin-bottom: 0.5rem; font-size: 1.25rem; color: #0c4a6e;">Select Payment Method</h3>
          <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">Choose how the payment was received</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem;">
            <button class="payment-option" data-method="cash" style="padding: 1rem; border: 2px solid #e2e8f0; background: white; color: #0c4a6e; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸ’µ</div>
              Cash
            </button>
            <button class="payment-option" data-method="upi" style="padding: 1rem; border: 2px solid #e2e8f0; background: white; color: #0c4a6e; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸ“±</div>
              UPI
            </button>
            <button class="payment-option" data-method="card" style="padding: 1rem; border: 2px solid #e2e8f0; background: white; color: #0c4a6e; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸ’³</div>
              Card
            </button>
            <button class="payment-option" data-method="online" style="padding: 1rem; border: 2px solid #e2e8f0; background: white; color: #0c4a6e; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸŒ</div>
              Online
            </button>
          </div>
          <button id="methodCancel" style="padding: 0.625rem 1.5rem; border: 1px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; cursor: pointer; font-weight: 500; width: 100%;">Cancel</button>
        `;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(methodMsg);
        
        methodMsg.querySelectorAll('.payment-option').forEach(btn => {
          btn.onmouseover = () => {
            btn.style.borderColor = '#10b981';
            btn.style.background = '#f0fdf4';
          };
          btn.onmouseout = () => {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
          };
          btn.onclick = () => {
            const method = btn.getAttribute('data-method');
            document.body.removeChild(methodMsg);
            document.body.removeChild(overlay);
            resolve(method);
          };
        });
        
        methodMsg.querySelector('#methodCancel').onclick = () => {
          document.body.removeChild(methodMsg);
          document.body.removeChild(overlay);
          resolve(null);
        };
        
        overlay.onclick = () => {
          document.body.removeChild(methodMsg);
          document.body.removeChild(overlay);
          resolve(null);
        };
      });
      
      if (!paymentMethod) return;
      
      try {
        const res = await fetch(`/api/invoices/${invoiceId}/payment`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            payment_status: 'paid',
            payment_method: paymentMethod.toLowerCase()
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Success', `Invoice marked as paid (${paymentMethod.toUpperCase()})`, 'success');
          loadInvoiceStats();
          loadAllInvoices();
          loadTodaysCheckouts();
        } else {
          showToast('Error', data.message || 'Failed to update payment', 'error');
        }
      } catch (error) {
        console.error('Mark paid error:', error);
        showToast('Error', 'Network error updating payment', 'error');
      }
    }
    
    // Send Invoice via WhatsApp
    async function sendInvoiceWhatsApp(invoiceId) {
      console.log('ğŸ“± Sending invoice via WhatsApp:', invoiceId);
      
      try {
        const res = await fetch('/whatsapp/send-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoice_id: invoiceId })
        });
        
        console.log('Response status:', res.status);
        
        const data = await res.json();
        console.log('Response data:', data);
        
        if (data.success && data.whatsapp_url) {
          window.open(data.whatsapp_url, '_blank');
          showToast('Success', 'WhatsApp opened with invoice details', 'success');
        } else {
          showToast('Error', data.message || 'Failed to generate WhatsApp message', 'error');
        }
      } catch (error) {
        console.error('WhatsApp invoice error:', error);
        showToast('Error', 'Network error sending invoice: ' + error.message, 'error');
      }
    }

    // Open invoice modal
    function openInvoiceModal(visitId, patientName, patientMobile, doctorName, consultationFee, presPath) {
      const modal = document.getElementById('invoiceModal');
      
      document.getElementById('invoice_visit_id').value = visitId;
      document.getElementById('invoice_patient_name').textContent = patientName || 'Unknown';
      document.getElementById('invoice_patient_mobile').textContent = patientMobile || 'N/A';
      document.getElementById('invoice_doctor_name').textContent = doctorName || 'Unknown';
      document.getElementById('invoice_consultation_fee').value = consultationFee || 0;
      
      // Check prescription availability
      const prescriptionStatus = document.getElementById('prescription_status');
      const prescriptionCheckbox = document.getElementById('invoice_include_prescription');
      
      if (presPath && presPath !== '' && presPath !== 'null') {
        prescriptionStatus.textContent = 'Prescription available for this visit';
        prescriptionStatus.style.color = '#15803d';
        prescriptionCheckbox.disabled = false;
        prescriptionCheckbox.checked = true;
      } else {
        prescriptionStatus.textContent = 'No prescription for this visit';
        prescriptionStatus.style.color = '#94a3b8';
        prescriptionCheckbox.disabled = true;
        prescriptionCheckbox.checked = false;
      }
      
      document.getElementById('invoice_medicine_charges').value = 0;
      document.getElementById('invoice_lab_charges').value = 0;
      document.getElementById('invoice_other_charges').value = 0;
      document.getElementById('invoice_other_charges_desc').value = '';
      document.getElementById('invoice_discount').value = 0;
      document.getElementById('invoice_tax_percentage').value = 0;
      document.getElementById('invoice_payment_status').value = 'unpaid';
      document.getElementById('invoice_payment_method').value = '';
      document.getElementById('invoice_notes').value = '';
      document.getElementById('invoiceError').style.display = 'none';
      
      const paymentStatusSelect = document.getElementById('invoice_payment_status');
      const paymentMethodGroup = document.getElementById('payment_method_group');
      
      paymentStatusSelect.onchange = function() {
        paymentMethodGroup.style.display = this.value === 'paid' ? 'block' : 'none';
      };
      
      modal.style.display = 'flex';
      modal.classList.add('show');
    }

    function closeInvoiceModal() {
      const modal = document.getElementById('invoiceModal');
      modal.style.display = 'none';
      modal.classList.remove('show');
    }
    
    // Toggle billing section collapse
    function toggleBillingSection() {
      const body = document.getElementById('billingBody');
      const icon = document.getElementById('billingIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Toggle video consultations section collapse
    function toggleVideoSection() {
      const body = document.getElementById('videoBody');
      const icon = document.getElementById('videoIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
        // Load data when section is opened
        loadVideoConsultationsOverview();
        loadVideoConsultationsDetailList();
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Toggle prescription section collapse
    function togglePrescriptionSection() {
      const body = document.getElementById('prescriptionBody');
      const icon = document.getElementById('prescriptionIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
        // Populate doctor dropdown when section opens
        populatePrescriptionDoctorFilter();
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Populate prescription doctor filter dropdown
    async function populatePrescriptionDoctorFilter() {
      try {
        const sessionRes = await fetch('/clinic/session');
        const sessionData = await sessionRes.json();
        if (!sessionData.success || !sessionData.clinic) return;
        
        const clinicId = sessionData.clinic.clinic_id;
        const res = await fetch(`/doctors/clinic/${clinicId}`);
        const data = await res.json();
        
        if (data.success && data.doctors) {
          const select = document.getElementById('prescriptionDoctorFilter');
          select.innerHTML = '<option value="">All Doctors</option>' + 
            data.doctors.map(d => `<option value="${d.doctor_id}">${d.full_name}</option>`).join('');
        }
      } catch (err) {
        console.error('Error loading doctors for prescription filter:', err);
      }
    }

    // Search prescriptions
    async function searchPrescriptions() {
      const dateFilter = document.getElementById('prescriptionDateFilter').value;
      const mobileFilter = document.getElementById('prescriptionMobileFilter').value.trim();
      const doctorFilter = document.getElementById('prescriptionDoctorFilter').value;
      
      // Show loading
      document.getElementById('prescriptionLoading').style.display = 'block';
      document.getElementById('prescriptionEmptyState').style.display = 'none';
      document.getElementById('prescriptionTable').style.display = 'none';
      document.getElementById('prescriptionStats').style.display = 'none';
      
      // Add loading to refresh button
      const btn = document.getElementById('prescriptionRefreshBtn');
      if (btn) btn.classList.add('loading');
      
      try {
        const sessionRes = await fetch('/clinic/session');
        const sessionData = await sessionRes.json();
        if (!sessionData.success || !sessionData.clinic) {
          throw new Error('Not logged in');
        }
        
        const clinicId = sessionData.clinic.clinic_id;
        
        // Build query params
        let url = `/history/clinic/${clinicId}/prescriptions?`;
        const params = [];
        if (dateFilter) params.push(`date=${dateFilter}`);
        if (mobileFilter) params.push(`mobile=${mobileFilter}`);
        if (doctorFilter) params.push(`doctor_id=${doctorFilter}`);
        url += params.join('&');
        
        const res = await fetch(url);
        const data = await res.json();
        
        document.getElementById('prescriptionLoading').style.display = 'none';
        
        if (data.success && data.visits && data.visits.length > 0) {
          renderPrescriptionTable(data.visits);
          document.getElementById('prescriptionResultCount').textContent = data.visits.length;
          document.getElementById('prescriptionStats').style.display = 'block';
          document.getElementById('prescriptionTable').style.display = 'table';
          document.getElementById('prescriptionEmptyState').style.display = 'none';
        } else {
          document.getElementById('prescriptionTable').style.display = 'none';
          document.getElementById('prescriptionStats').style.display = 'none';
          document.getElementById('prescriptionEmptyState').innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 0.75rem;">ğŸ”</div>
            <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">No Prescriptions Found</div>
            <div style="font-size: 0.875rem;">Try adjusting your search filters</div>
          `;
          document.getElementById('prescriptionEmptyState').style.display = 'block';
        }
      } catch (err) {
        console.error('Error searching prescriptions:', err);
        document.getElementById('prescriptionLoading').style.display = 'none';
        document.getElementById('prescriptionEmptyState').innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 0.75rem;">âŒ</div>
          <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">Error Loading Prescriptions</div>
          <div style="font-size: 0.875rem;">${err.message || 'Please try again'}</div>
        `;
        document.getElementById('prescriptionEmptyState').style.display = 'block';
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    // Render prescription table
    function renderPrescriptionTable(visits) {
      const tbody = document.getElementById('prescriptionTableBody');
      tbody.innerHTML = visits.map(v => {
        const visitDate = v.visit_time ? new Date(v.visit_time).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : '-';
        const visitTime = v.visit_time ? new Date(v.visit_time).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : '';
        const hasPrescription = v.pres_path ? true : false;
        
        return `
          <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 0.75rem; vertical-align: middle;">
              <div style="font-weight: 600; color: #1e293b;">${visitDate}</div>
              <div style="font-size: 0.75rem; color: #64748b;">${visitTime}</div>
            </td>
            <td style="padding: 0.75rem; vertical-align: middle;">
              <div style="font-weight: 600; color: #1e293b;">${v.patient_name || '-'}</div>
              ${v.patient_age ? `<div style="font-size: 0.75rem; color: #64748b;">${v.patient_age} yrs${v.patient_gender ? ', ' + v.patient_gender : ''}</div>` : ''}
            </td>
            <td style="padding: 0.75rem; vertical-align: middle;">
              <span style="font-family: monospace; font-size: 0.875rem; color: #475569;">${v.patient_mobile || '-'}</span>
            </td>
            <td style="padding: 0.75rem; vertical-align: middle;">
              <div style="font-weight: 500; color: #1e293b;">${v.doctor_name || '-'}</div>
            </td>
            <td style="padding: 0.75rem; vertical-align: middle;">
              <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #475569;" title="${v.diagnosis || ''}">${v.diagnosis || '-'}</div>
            </td>
            <td style="padding: 0.75rem; vertical-align: middle; text-align: center;">
              <div style="display: flex; gap: 0.375rem; justify-content: center; flex-wrap: wrap;">
                ${hasPrescription ? `
                  <button onclick="printPrescription('${v.pres_path}')" class="btn btn-sm" style="background: #f3e8ff; color: #7c3aed; border: none; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" title="Print">
                    ğŸ–¨ï¸ Print
                  </button>
                  <button onclick="sharePrescriptionWhatsApp('${v.visit_id}', '${v.patient_mobile || ''}')" class="btn btn-sm" style="background: #dcfce7; color: #16a34a; border: none; padding: 0.375rem 0.5rem; font-size: 0.75rem; border-radius: 4px;" title="Share via WhatsApp">
                    ğŸ’¬ WhatsApp
                  </button>
                ` : `
                  <span style="color: #94a3b8; font-size: 0.75rem; font-style: italic;">No prescription</span>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Print prescription
    function printPrescription(presPath) {
      if (presPath) {
        const printWindow = window.open(presPath, '_blank');
        printWindow.onload = function() {
          printWindow.print();
        };
      }
    }

    // Print invoice
    function printInvoice(invoicePath) {
      if (invoicePath) {
        const printWindow = window.open(invoicePath, '_blank');
        printWindow.onload = function() {
          printWindow.print();
        };
      }
    }

    // Share prescription via WhatsApp
    async function sharePrescriptionWhatsApp(visitId, patientMobile) {
      if (!patientMobile) {
        showToast('Error', 'Patient mobile number not available', 'error');
        return;
      }
      
      try {
        const res = await fetch('/whatsapp/send-prescription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ visit_id: visitId })
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('Success', 'Prescription sent via WhatsApp!', 'success');
        } else {
          showToast('Error', data.message || 'Failed to send prescription', 'error');
        }
      } catch (err) {
        console.error('Error sending prescription via WhatsApp:', err);
        showToast('Error', 'Failed to send prescription via WhatsApp', 'error');
      }
    }

    // Clear prescription filters
    function clearPrescriptionFilters() {
      document.getElementById('prescriptionDateFilter').value = '';
      document.getElementById('prescriptionMobileFilter').value = '';
      document.getElementById('prescriptionDoctorFilter').value = '';
      
      document.getElementById('prescriptionTable').style.display = 'none';
      document.getElementById('prescriptionStats').style.display = 'none';
      document.getElementById('prescriptionEmptyState').innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 0.75rem;">ğŸ“‹</div>
        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">Search for Patient Prescriptions</div>
        <div style="font-size: 0.875rem;">Enter visit date or patient mobile number to find prescriptions</div>
      `;
      document.getElementById('prescriptionEmptyState').style.display = 'block';
    }
    
    // Store video consultations for filtering
    let allVideoConsultations = [];
    let videoReadyForInvoice = [];
    
    // Load detailed video consultations list
    async function loadVideoConsultationsDetailList() {
      const container = document.getElementById('videoConsultationsDetailList');
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #64748b;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
          <div>Loading consultations...</div>
        </div>
      `;
      
      try {
        if (!currentClinicId) {
          // Try to get clinic ID from session
          const sessionRes = await fetch('/clinic/profile');
          const sessionData = await sessionRes.json();
          if (sessionData.success && sessionData.clinic) {
            currentClinicId = sessionData.clinic.clinic_id;
          }
        }
        
        if (!currentClinicId) {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">Session not loaded</div>';
          return;
        }
        
        // Fetch video consultations and video checkouts in parallel
        const [consultRes, checkoutRes] = await Promise.all([
          fetch(`/bookings/clinic-video-consultations?clinic_id=${currentClinicId}`),
          fetch(`/api/invoices/clinic/${currentClinicId}/video-checkouts`)
        ]);
        
        const consultData = await consultRes.json();
        const checkoutData = await checkoutRes.json();
        
        if (consultData.success) {
          allVideoConsultations = consultData.consultations || [];
        }
        
        if (checkoutData.success) {
          videoReadyForInvoice = checkoutData.checkouts || [];
        }
        
        filterVideoConsultationsList();
      } catch (error) {
        console.error('Error loading video consultations:', error);
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Network error</div>';
      }
    }
    
    // Filter and render video consultations
    function filterVideoConsultationsList() {
      const container = document.getElementById('videoConsultationsDetailList');
      const filterSelect = document.getElementById('videoPaymentFilter');
      const filter = filterSelect ? filterSelect.value : 'all';
      
      // Calculate counts for each category
      // Video Queue: Not yet seen (upcoming/in-progress)
      const videoQueue = allVideoConsultations.filter(c => c.consult_status !== 'seen' && c.consult_status !== 'cancelled');
      
      // Awaiting Payment: Seen but not paid yet
      const awaitingPayment = allVideoConsultations.filter(c => c.consult_status === 'seen' && c.payment_status !== 'CONFIRMED');
      
      // Ready for Invoice: Paid + Seen + No invoice (from videoReadyForInvoice endpoint)
      const readyForInvoice = videoReadyForInvoice;
      
      // Update counts
      document.getElementById('videoQueueCount').textContent = `${videoQueue.length} Queue`;
      document.getElementById('videoAwaitingPaymentCount').textContent = `${awaitingPayment.length} Awaiting`;
      document.getElementById('videoReadyInvoiceCount').textContent = `${readyForInvoice.length} Ready`;
      
      // Filter based on selection
      let consultations = [];
      let showInvoiceBtn = false;
      
      if (filter === 'queue') {
        consultations = videoQueue;
      } else if (filter === 'awaiting') {
        consultations = awaitingPayment;
      } else if (filter === 'ready') {
        consultations = readyForInvoice.map(r => ({
          ...r,
          consult_status: 'seen',
          payment_status: 'CONFIRMED',
          _isReadyForInvoice: true
        }));
        showInvoiceBtn = true;
      } else {
        // All: show everything
        consultations = allVideoConsultations;
      }
      
      renderVideoConsultationsList(consultations, container, showInvoiceBtn);
    }
    
    // Render video consultations list
    function renderVideoConsultationsList(consultations, container, showInvoiceBtn = false) {
      if (!consultations.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #64748b;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ“¹</div>
            <div style="font-size: 1rem; font-weight: 500;">No video consultations found</div>
          </div>
        `;
        return;
      }
      
      let html = '<div class="video-table-wrapper" style="overflow-x: auto;"><table class="video-table" style="width: 100%; border-collapse: collapse;">';
      html += `
        <thead>
          <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ‘¤ Patient</th>
            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ‘¨â€âš•ï¸ Doctor</th>
            <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ“… Schedule</th>
            <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ“‹ Status</th>
            <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">ğŸ’° Payment</th>
            <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; color: #64748b; font-weight: 600;">âš¡ Actions</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      consultations.forEach((c, index) => {
        const isPaid = c.payment_status === 'CONFIRMED';
        const isSeen = c.consult_status === 'seen';
        const hasInvoice = !!c.invoice_id;
        const invoicePaid = c.invoice_payment_status === 'paid';
        const isReadyForInvoice = c._isReadyForInvoice || (isPaid && isSeen && c.visit_id && !hasInvoice);
        const bgColor = index % 2 === 0 ? 'white' : '#f8fafc';
        
        // Payment badge - if invoice exists, show invoice payment status
        let paymentBadge;
        if (hasInvoice) {
          paymentBadge = invoicePaid
            ? '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">âœ“ PAID</span>'
            : '<span style="background: #fee2e2; color: #dc2626; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">INVOICE UNPAID</span>';
        } else {
          paymentBadge = isPaid 
            ? '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">âœ“ PAID</span>'
            : '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">UNPAID</span>';
        }
        
        const statusBadge = getVideoStatusBadge(c.consult_status);
        const dateStr = formatVideoDate(c.appointment_date);
        const timeStr = c.appointment_time || '--:--';
        
        // Determine which action button to show
        let actionBtn = '';
        if (hasInvoice) {
          // Invoice already exists
          if (invoicePaid) {
            actionBtn = '<span style="background: #dcfce7; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">âœ“ Complete</span>';
          } else {
            actionBtn = `<button onclick="scrollToInvoice('${c.invoice_id}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap;">ğŸ“‹ View Invoice</button>`;
          }
        } else if (isReadyForInvoice && c.visit_id) {
          actionBtn = `<button onclick="openInvoiceModal('${c.visit_id}', '${(c.patient_name || '').replace(/'/g, "\\'")}', '${c.patient_mobile || ''}', '${(c.doctor_name || '').replace(/'/g, "\\'")}', ${c.consultation_fee || 0}, '${c.pres_path || ''}')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap;">ğŸ§¾ Checkout</button>`;
        } else if (isSeen && !isPaid) {
          actionBtn = `<button onclick="markVideoBookingPaid('${c.appointment_id}')" style="background: linear-gradient(135deg, #10b981 0%, #22c55e 100%); color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap;">ğŸ’° Mark Paid</button>`;
        } else if (!isSeen && !isPaid) {
          actionBtn = `<button onclick="markVideoBookingPaid('${c.appointment_id}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap;">ğŸ’³ Pre-Pay</button>`;
        } else if (!isSeen && isPaid) {
          actionBtn = '<span style="background: #dbeafe; color: #2563eb; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">â³ Waiting</span>';
        } else {
          actionBtn = '<span style="color: #9ca3af; font-size: 0.75rem;">â€”</span>';
        }
        
        html += `
          <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 0.75rem;">
              <div style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">${c.patient_name || 'Unknown'}</div>
              <div style="color: #64748b; font-size: 0.75rem; font-family: monospace;">${c.patient_mobile || 'N/A'}</div>
            </td>
            <td style="padding: 0.75rem; font-size: 0.875rem; color: #475569; font-weight: 500;">${c.doctor_name || 'Unknown'}</td>
            <td style="padding: 0.75rem; text-align: center;">
              <div style="font-weight: 600; color: #1e293b; font-size: 0.8125rem;">${dateStr}</div>
              <div style="color: #64748b; font-size: 0.75rem;">${timeStr}</div>
            </td>
            <td style="padding: 0.75rem; text-align: center;">
              ${statusBadge}
            </td>
            <td style="padding: 0.75rem; text-align: center;">
              ${paymentBadge}
            </td>
            <td style="padding: 0.75rem; text-align: center;">
              ${actionBtn}
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    // Get status badge for video consultation
    function getVideoStatusBadge(status) {
      const badges = {
        'not_seen': '<span style="background: #e2e8f0; color: #475569; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem;">Not Started</span>',
        'in_progress': '<span style="background: #dbeafe; color: #2563eb; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem;">In Progress</span>',
        'seen': '<span style="background: #dcfce7; color: #16a34a; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem;">Completed</span>',
        'cancelled': '<span style="background: #fee2e2; color: #dc2626; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem;">Cancelled</span>'
      };
      return badges[status] || badges['not_seen'];
    }
    
    // Format date for video list
    function formatVideoDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const d = new Date(dateStr);
        const today = new Date();
        today.setHours(0,0,0,0);
        const dateOnly = new Date(d);
        dateOnly.setHours(0,0,0,0);
        
        const dayDiff = Math.floor((dateOnly - today) / (1000 * 60 * 60 * 24));
        
        if (dayDiff === 0) return 'Today';
        if (dayDiff === 1) return 'Tomorrow';
        if (dayDiff === -1) return 'Yesterday';
        
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } catch(e) { return dateStr; }
    }
    
    // Scroll to invoice in Invoice Management section
    function scrollToInvoice(invoiceId) {
      // Open the billing section if collapsed
      const billingBody = document.getElementById('billingBody');
      if (billingBody.style.display === 'none') {
        toggleBillingSection();
      }
      
      // Scroll to billing section
      document.querySelector('.billing-section').scrollIntoView({ behavior: 'smooth' });
      
      // Highlight the invoice search
      setTimeout(() => {
        const searchInput = document.getElementById('invoicePatientSearch');
        if (searchInput) {
          searchInput.value = invoiceId;
          loadAllInvoices();
          showToast('Info', `Showing invoice ${invoiceId}`, 'info');
        }
      }, 500);
    }
    
    // Mark video booking as paid
    async function markVideoBookingPaid(appointmentId) {
      const paymentMethod = prompt('Payment method (cash/upi/card/online):', 'upi');
      if (!paymentMethod) return;
      
      try {
        const res = await fetch(`/bookings/${appointmentId}/payment-status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            payment_status: 'CONFIRMED',
            payment_method: paymentMethod 
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Success', 'Payment marked as confirmed!', 'success');
          loadVideoConsultationsDetailList(); // Refresh list
          loadVideoConsultationsOverview(); // Refresh stats
        } else {
          showToast('Error', data.message || 'Unknown error', 'error');
        }
      } catch (error) {
        console.error('Mark as paid error:', error);
        showToast('Error', 'Network error. Please try again.', 'error');
      }
    }

    // Load video consultations overview data
    async function loadVideoConsultationsOverview() {
      const container = document.getElementById('doctorVideoList');
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #64748b;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
          <div>Loading video consultations...</div>
        </div>
      `;
      
      try {
        const response = await fetch('/clinic/video-consultations', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('clinicToken')
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load video consultations');
        }
        
        const data = await response.json();
        
        // Update summary stats
        document.getElementById('statTodayVideoCalls').textContent = data.summary.todayConsultations || 0;
        document.getElementById('statPendingJoins').textContent = data.summary.pendingJoins || 0;
        document.getElementById('statLinksSent').textContent = data.summary.linksSent || 0;
        document.getElementById('statWeekVideoCalls').textContent = data.summary.weekConsultations || 0;
        
        // Render doctor list
        if (!data.doctors || data.doctors.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #64748b;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¹</div>
              <div style="font-size: 1rem; margin-bottom: 0.5rem;">No video consultations yet</div>
              <div style="font-size: 0.875rem; color: #9ca3af;">Doctors can generate join links from their dashboard</div>
            </div>
          `;
          return;
        }
        
        let html = '<div style="display: grid; gap: 1rem;">';
        
        data.doctors.forEach(doctor => {
          const statusColor = doctor.todayConsultations > 0 ? '#16a34a' : '#64748b';
          const statusBg = doctor.todayConsultations > 0 ? '#dcfce7' : '#f1f5f9';
          
          html += `
            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: ${statusBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                  ğŸ‘¨â€âš•ï¸
                </div>
                <div>
                  <div style="font-weight: 600; color: #1e293b; font-size: 1rem;">Dr. ${doctor.doctorName}</div>
                  <div style="font-size: 0.8125rem; color: #64748b;">${doctor.specialization || 'General Practice'}</div>
                </div>
              </div>
              <div style="display: flex; gap: 1.5rem; text-align: center;">
                <div>
                  <div style="font-size: 1.25rem; font-weight: 700; color: ${statusColor};">${doctor.todayConsultations}</div>
                  <div style="font-size: 0.6875rem; color: #9ca3af;">Today</div>
                </div>
                <div>
                  <div style="font-size: 1.25rem; font-weight: 700; color: #d97706;">${doctor.pendingJoins}</div>
                  <div style="font-size: 0.6875rem; color: #9ca3af;">Pending</div>
                </div>
                <div>
                  <div style="font-size: 1.25rem; font-weight: 700; color: #2563eb;">${doctor.totalLinksSent}</div>
                  <div style="font-size: 0.6875rem; color: #9ca3af;">Links Sent</div>
                </div>
                <div>
                  <div style="font-size: 1.25rem; font-weight: 700; color: #7c3aed;">${doctor.weekConsultations}</div>
                  <div style="font-size: 0.6875rem; color: #9ca3af;">This Week</div>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading video consultations:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #dc2626;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">âš ï¸</div>
            <div>Failed to load video consultations</div>
            <button onclick="loadVideoConsultationsOverview()" class="btn btn-sm btn-outline" style="margin-top: 1rem;">Try Again</button>
          </div>
        `;
      }
    }

    function toggleQRSection() {
      const body = document.getElementById('qrBody');
      const icon = document.getElementById('qrIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    function toggleAppointmentsSection() {
      const body = document.getElementById('appointmentsBody');
      const icon = document.getElementById('appointmentsIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Handle invoice form submission
    // Invoice form submission handler
    function setupInvoiceFormHandler() {
      const invoiceForm = document.getElementById('invoiceForm');
      if (!invoiceForm) {
        console.error('âŒ Invoice form not found! DOM may not be ready yet.');
        return false;
      }
      
      // Remove any existing listeners to prevent duplicates
      const newForm = invoiceForm.cloneNode(true);
      invoiceForm.parentNode.replaceChild(newForm, invoiceForm);
      
      console.log('âœ… Invoice form handler attached');
      
      document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('ğŸ“ Invoice form submitted!');
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const errorDiv = document.getElementById('invoiceError');
        errorDiv.style.display = 'none';
        
        const visitId = document.getElementById('invoice_visit_id').value;
        const consultationFee = parseFloat(document.getElementById('invoice_consultation_fee').value) || 0;
        const medicineCharges = parseFloat(document.getElementById('invoice_medicine_charges').value) || 0;
        const labCharges = parseFloat(document.getElementById('invoice_lab_charges').value) || 0;
        const otherCharges = parseFloat(document.getElementById('invoice_other_charges').value) || 0;
        const otherChargesDesc = document.getElementById('invoice_other_charges_desc').value.trim();
        const discount = parseFloat(document.getElementById('invoice_discount').value) || 0;
        const taxPercentage = parseFloat(document.getElementById('invoice_tax_percentage').value) || 0;
        const paymentStatus = document.getElementById('invoice_payment_status').value;
        const paymentMethod = document.getElementById('invoice_payment_method').value || null;
        const notes = document.getElementById('invoice_notes').value.trim();
        const sendWhatsApp = document.getElementById('invoice_send_whatsapp')?.checked || false;
        const includePrescription = document.getElementById('invoice_include_prescription')?.checked || false;
        
        console.log('ğŸ“‹ Form data:', { visitId, consultationFee, medicineCharges, labCharges, otherCharges });
        console.log('ğŸ“± WhatsApp settings:', { sendWhatsApp, includePrescription });
        
        if (!visitId) {
          console.error('âŒ Visit ID missing');
          errorDiv.textContent = 'Visit ID is missing';
          errorDiv.style.display = 'block';
          return;
        }
        
        const total = consultationFee + medicineCharges + labCharges + otherCharges;
        console.log('ğŸ’° Total before adjustments:', total);
        
        if (total <= 0) {
          console.error('âŒ Total is zero or negative');
          errorDiv.textContent = 'Total amount must be greater than zero';
          errorDiv.style.display = 'block';
          return;
        }
        
        if (paymentStatus === 'paid' && !paymentMethod) {
          console.error('âŒ Payment method missing for paid invoice');
          errorDiv.textContent = 'Please select payment method for paid invoice';
          errorDiv.style.display = 'block';
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Generating...';
        
        console.log('ğŸš€ Sending invoice generation request...');
        
        try {
          const response = await fetch('/api/invoices/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              visit_id: visitId,
              consultation_fee: consultationFee,
              medicine_charges: medicineCharges,
              lab_charges: labCharges,
              other_charges: otherCharges,
              other_charges_desc: otherChargesDesc,
              discount: discount,
              tax_percentage: taxPercentage,
              payment_status: paymentStatus,
              payment_method: paymentMethod,
              notes: notes,
              send_whatsapp: sendWhatsApp,
              include_prescription: includePrescription
            })
          });
          
          console.log('ğŸ“¡ Response status:', response.status);
          
          const data = await response.json();
          console.log('ğŸ“¦ Response data:', data);
          
          if (data.success) {
            console.log('âœ… Invoice generated successfully!');
            console.log('ğŸ“± WhatsApp URL in response:', data.whatsapp_url);
            window.open(data.invoice_path, '_blank');
            
            // Open WhatsApp if URL was generated
            if (data.whatsapp_url) {
              console.log('ğŸ“± Opening WhatsApp...');
              setTimeout(() => {
                window.open(data.whatsapp_url, '_blank');
              }, 500);
            } else {
              console.log('âš ï¸ No WhatsApp URL in response');
            }
            
            closeInvoiceModal();
            
            showToast('Success', `Invoice ${data.invoice_id} generated - â‚¹${data.total_amount.toFixed(2)}`, 'success');
            
            setTimeout(() => {
              loadInvoiceStats();
              loadTodaysCheckouts();
              loadAllInvoices();
            }, 1000);
          } else {
            console.error('âŒ Invoice generation failed:', data.message);
            errorDiv.textContent = data.message || 'Failed to generate invoice';
            errorDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('âŒ Invoice generation error:', error);
          errorDiv.textContent = 'Network error. Please try again.';
          errorDiv.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Generate Invoice';
        }
      });
      
      return true;
    }
    
    // Initialize after DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ”„ DOM loaded, setting up invoice form handler...');
      setupInvoiceFormHandler();
      
      setTimeout(() => {
        initializeBillingSection();
      }, 1000);
    });
    
    // Also try immediately in case DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      console.log('ğŸ”„ DOM already loaded, setting up invoice form handler...');
      setTimeout(() => {
        setupInvoiceFormHandler();
        initializeBillingSection();
      }, 100);
    }
  </script>

  <!-- Invoice Generation Modal -->
  <div id="invoiceModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 0.75rem; overflow-y: auto; align-items: flex-start; justify-content: center;">
    <div style="background: white; max-width: 560px; width: 100%; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto;">
      <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; padding: 1rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1;">
        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 700;">ğŸ§¾ Generate Invoice</h3>
        <button onclick="closeInvoiceModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;">&times;</button>
      </div>
      <div style="padding: 1rem; max-height: 80vh; overflow-y: auto;">
        <form id="invoiceForm">
          <input type="hidden" id="invoice_visit_id" />
          
          <!-- Patient Info - Compact -->
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
            <div style="font-weight: 600; font-size: 1rem;" id="invoice_patient_name">-</div>
            <div style="font-size: 0.8125rem; opacity: 0.95; margin-top: 0.25rem;">ğŸ“± <span id="invoice_patient_mobile">-</span> &nbsp;|&nbsp; ğŸ‘¨â€âš•ï¸ <span id="invoice_doctor_name">-</span></div>
          </div>

          <!-- Charges - Compact Grid -->
          <div style="background: #f8fafc; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
            <div style="font-weight: 600; color: #334155; margin-bottom: 0.5rem; font-size: 0.875rem;">ğŸ’° Charges</div>
            <div class="invoice-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.125rem;">Consultation</label>
                <input type="number" id="invoice_consultation_fee" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" value="0" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.125rem;">Medicine</label>
                <input type="number" id="invoice_medicine_charges" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" value="0" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.125rem;">Lab</label>
                <input type="number" id="invoice_lab_charges" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" value="0" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.125rem;">Other</label>
                <input type="number" id="invoice_other_charges" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" value="0" />
              </div>
            </div>
            <div style="margin-top: 0.5rem;">
              <input type="text" id="invoice_other_charges_desc" class="form-input" style="padding: 0.5rem; font-size: 16px;" placeholder="Other charges description (e.g., X-Ray)" />
            </div>
          </div>

          <!-- Adjustments + Payment - Combined Row -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
            <div style="background: #fef3c7; padding: 0.625rem; border-radius: 8px;">
              <label style="display: block; font-size: 0.75rem; color: #78350f; margin-bottom: 0.125rem;">Discount (â‚¹)</label>
              <input type="number" id="invoice_discount" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" value="0" />
            </div>
            <div style="background: #fef3c7; padding: 0.625rem; border-radius: 8px;">
              <label style="display: block; font-size: 0.75rem; color: #78350f; margin-bottom: 0.125rem;">Tax (%)</label>
              <input type="number" id="invoice_tax_percentage" class="form-input" style="padding: 0.5rem; font-size: 16px;" step="0.01" min="0" max="100" value="0" />
            </div>
          </div>

          <!-- Payment Status -->
          <div style="background: #eff6ff; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
            <div class="invoice-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: #1e3a8a; margin-bottom: 0.125rem;">Status *</label>
                <select id="invoice_payment_status" class="form-input" style="padding: 0.5rem; font-size: 16px;" required>
                  <option value="unpaid">Unpaid</option>
                  <option value="paid">Paid</option>
                </select>
              </div>
              <div id="payment_method_group" style="display: none;">
                <label style="display: block; font-size: 0.75rem; color: #1e3a8a; margin-bottom: 0.125rem;">Method</label>
                <select id="invoice_payment_method" class="form-input" style="padding: 0.5rem; font-size: 16px;">
                  <option value="">Select</option>
                  <option value="cash">Cash</option>
                  <option value="upi">UPI</option>
                  <option value="card">Card</option>
                  <option value="online">Online</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Notes - Optional, Collapsible feel -->
          <div style="margin-bottom: 0.75rem;">
            <textarea id="invoice_notes" class="form-input" style="padding: 0.5rem; font-size: 16px;" rows="2" placeholder="Notes (optional)"></textarea>
          </div>
          
          <!-- WhatsApp Notification - Compact -->
          <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="invoice_send_whatsapp" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: #10b981; flex-shrink: 0;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #166534; font-size: 0.875rem;">ğŸ’¬ Send via WhatsApp</div>
              </div>
            </label>
            
            <div id="prescription_checkbox_wrapper" style="margin-top: 0.5rem; padding-left: 1.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="invoice_include_prescription" style="width: 16px; height: 16px; cursor: pointer; accent-color: #10b981; flex-shrink: 0;">
                <span id="prescription_status" style="font-size: 0.75rem; color: #15803d;">Include prescription</span>
              </label>
            </div>
          </div>

          <!-- Error Display -->
          <div id="invoiceError" style="display: none; background: #fee2e2; color: #991b1b; padding: 0.625rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.8125rem;"></div>

          <!-- Action Buttons -->
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 0.5rem;">
            <button type="button" onclick="closeInvoiceModal()" class="btn btn-outline" style="padding: 0.75rem;">Cancel</button>
            <button type="submit" class="btn btn-success" style="padding: 0.75rem; font-weight: 700;">ğŸ§¾ Generate Invoice</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>
</html>
