<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Video Consultation - DoctorPod</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 2rem;
      text-align: center;
    }

    .logo {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    h1 {
      color: #1e293b;
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #64748b;
      margin-bottom: 2rem;
    }

    .input-group {
      margin-bottom: 1.5rem;
      text-align: left;
    }

    label {
      display: block;
      color: #475569;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    input {
      width: 100%;
      padding: 0.875rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.875rem;
      display: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Join Form -->
  <div class="container" id="joinForm">
    <div class="logo">üìπ</div>
    <h1>Join Video Consultation</h1>
    <p class="subtitle">Enter your booking reference to join</p>

    <form id="bookingForm">
      <div class="input-group">
        <label for="bookingRef">Booking Reference</label>
        <input 
          type="text" 
          id="bookingRef" 
          placeholder="e.g., JOHN1234567890"
          required
          autocomplete="off"
        />
      </div>

      <div class="input-group">
        <label for="mobile">Mobile Number</label>
        <input 
          type="tel" 
          id="mobile" 
          placeholder="9876543210"
          maxlength="10"
          pattern="[0-9]{10}"
          required
        />
      </div>

      <button type="submit" class="btn" id="joinBtn">
        Check Status & Join
      </button>

      <div class="error" id="error"></div>
    </form>
  </div>

  <!-- Waiting Room (shown after verification, before doctor is ready) -->
  <div class="container" id="waitingRoom" style="display: none;">
    <div class="logo" id="waitingIcon">‚è≥</div>
    <h1 id="waitingTitle">Waiting for Doctor</h1>
    <p class="subtitle" id="waitingSubtitle">Please wait, your doctor will start the call soon</p>
    
    <div style="background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; text-align: left;">
      <div style="margin-bottom: 0.75rem;">
        <span style="color: #64748b; font-size: 0.875rem;">Doctor:</span>
        <span style="font-weight: 600; color: #1e293b;" id="waitingDoctorName">-</span>
      </div>
      <div style="margin-bottom: 0.75rem;">
        <span style="color: #64748b; font-size: 0.875rem;">Date:</span>
        <span style="font-weight: 600; color: #1e293b;" id="waitingDate">-</span>
      </div>
      <div style="margin-bottom: 0.75rem;">
        <span style="color: #64748b; font-size: 0.875rem;">Scheduled Time:</span>
        <span style="font-weight: 600; color: #1e293b;" id="waitingTime">-</span>
      </div>
      <div>
        <span style="color: #64748b; font-size: 0.875rem;">Your Slot:</span>
        <span style="font-weight: 700; color: #6366f1;" id="waitingSlot">#-</span>
      </div>
    </div>
    
    <div id="statusIndicator" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; background: #fef3c7; border: 1px solid #fcd34d;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
        <span class="pulse-dot" style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; animation: pulse 1.5s infinite;"></span>
        <span style="font-weight: 600; color: #92400e;" id="statusText">Doctor not started yet</span>
      </div>
    </div>
    
    <button class="btn" id="joinNowBtn" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
      üé• Join Video Call Now
    </button>
    
    <button class="btn" id="backBtn" style="margin-top: 1rem; background: #64748b;">
      ‚Üê Back
    </button>
    
    <p style="font-size: 0.8rem; color: #64748b; margin-top: 1rem;">
      ‚ÑπÔ∏è This page auto-refreshes every 5 seconds
    </p>
  </div>

  <style>
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
  </style>

  <script>
    const joinForm = document.getElementById('joinForm');
    const waitingRoom = document.getElementById('waitingRoom');
    const bookingForm = document.getElementById('bookingForm');
    const bookingRefInput = document.getElementById('bookingRef');
    const mobileInput = document.getElementById('mobile');
    const joinBtn = document.getElementById('joinBtn');
    const joinNowBtn = document.getElementById('joinNowBtn');
    const backBtn = document.getElementById('backBtn');
    const error = document.getElementById('error');

    let appointmentId = null;
    let statusPollInterval = null;
    let currentMobile = '';
    let doctorName = '';
    let patientName = '';

    // Auto-populate form from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const bookingRefParam = urlParams.get('booking_ref');
    const appointmentIdParam = urlParams.get('appointment_id');
    const tokenParam = urlParams.get('token');

    if (bookingRefParam) {
      bookingRefInput.value = bookingRefParam;
    }
    if (appointmentIdParam) {
      bookingRefInput.value = appointmentIdParam;
    }

    // Handle token-based access (from secure join link)
    if (tokenParam) {
      handleTokenAccess(tokenParam);
    }

    async function handleTokenAccess(token) {
      joinBtn.disabled = true;
      joinBtn.textContent = 'Verifying link...';
      error.style.display = 'none';

      try {
        const response = await fetch(`/join/validate-token/${encodeURIComponent(token)}`);
        const data = await response.json();

        if (!response.ok || !data.success) {
          showError(data.message || 'Invalid or expired link. Please enter your booking details manually.');
          joinBtn.disabled = false;
          joinBtn.textContent = 'Check Status & Join';
          return;
        }

        // Auto-fill form with token data
        bookingRefInput.value = data.appointment_id || '';
        if (data.patient_mobile) {
          // Show hint about mobile (last 4 digits shown)
          mobileInput.placeholder = `Ends with ...${data.patient_mobile}`;
        }

        // Update waiting room with appointment details
        document.getElementById('waitingDoctorName').textContent = data.doctor_name ? `Dr. ${data.doctor_name}` : '-';
        document.getElementById('waitingDate').textContent = data.appointment_date || '-';
        document.getElementById('waitingTime').textContent = data.appointment_time || '-';
        document.getElementById('waitingSlot').textContent = `#${data.queue_number || '-'}`;

        // Show message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'background:#dcfce7; color:#166534; padding:0.75rem; border-radius:6px; margin:1rem 0; text-align:center;';
        successMsg.innerHTML = `‚úÖ Link verified! Patient: <strong>${data.patient_name || '-'}</strong><br><small>Enter your mobile number to continue</small>`;
        bookingForm.insertBefore(successMsg, bookingForm.firstChild);

        joinBtn.disabled = false;
        joinBtn.textContent = 'Check Status & Join';

      } catch (err) {
        console.error('Token validation error:', err);
        showError('Failed to verify link. Please enter your booking details manually.');
        joinBtn.disabled = false;
        joinBtn.textContent = 'Check Status & Join';
      }
    }

    // Handle form submission - now shows waiting room
    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const bookingRef = bookingRefInput.value.trim();
      const mobile = mobileInput.value.trim();

      if (!bookingRef) {
        showError('Please enter booking reference');
        return;
      }

      joinBtn.disabled = true;
      joinBtn.textContent = 'Checking...';
      error.style.display = 'none';

      try {
        // Check video call status
        const statusUrl = `/bookings/${bookingRef}/video-status${mobile ? '?mobile=' + mobile : ''}`;
        const response = await fetch(statusUrl);
        const data = await response.json();

        if (!response.ok || !data.success) {
          showError(data.message || 'Invalid booking reference');
          return;
        }

        // Store values
        appointmentId = data.appointment_id;
        currentMobile = mobile;
        doctorName = data.doctor_name || '';
        patientName = data.patient_name || '';

        // Update waiting room with appointment details
        document.getElementById('waitingDoctorName').textContent = data.doctor_name ? `Dr. ${data.doctor_name}` : '-';
        document.getElementById('waitingDate').textContent = data.appointment_date || '-';
        document.getElementById('waitingTime').textContent = data.appointment_time || '-';
        document.getElementById('waitingSlot').textContent = `#${data.queue_number || '-'}`;

        // Check if doctor is ready
        updateWaitingStatus(data);

        // Show waiting room
        joinForm.style.display = 'none';
        waitingRoom.style.display = 'block';

        // Start polling for status updates
        startStatusPolling();

      } catch (err) {
        console.error('Verification error:', err);
        showError('Failed to verify booking. Please try again.');
      } finally {
        joinBtn.disabled = false;
        joinBtn.textContent = 'Check Status & Join';
      }
    });

    function updateWaitingStatus(data) {
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      const waitingIcon = document.getElementById('waitingIcon');
      const waitingTitle = document.getElementById('waitingTitle');
      const waitingSubtitle = document.getElementById('waitingSubtitle');

      // Check time window first
      if (data.time_window_valid === false) {
        // Outside time window
        statusIndicator.style.background = '#fef3c7';
        statusIndicator.style.borderColor = '#fcd34d';
        statusText.innerHTML = `‚è∞ ${data.time_window_message || 'Not within scheduled time'}`;
        statusText.style.color = '#92400e';
        
        waitingIcon.textContent = '‚è∞';
        waitingTitle.textContent = 'Not Yet Time';
        if (data.minutes_until_window > 0) {
          waitingSubtitle.textContent = `Your appointment window opens in ${data.minutes_until_window} minutes`;
        } else {
          waitingSubtitle.textContent = data.time_window_message || 'Please check your appointment time';
        }
        
        joinNowBtn.style.display = 'none';
        return; // Don't check other statuses
      }

      if (data.can_join || data.video_call_status === 'doctor_ready' || data.video_call_status === 'in_progress') {
        // Doctor is ready!
        statusIndicator.style.background = '#dcfce7';
        statusIndicator.style.borderColor = '#86efac';
        statusText.textContent = '‚úÖ Doctor is ready! You can join now';
        statusText.style.color = '#166534';
        
        waitingIcon.textContent = 'üé•';
        waitingTitle.textContent = 'Doctor is Ready!';
        waitingSubtitle.textContent = 'Click the button below to join your video consultation';
        
        joinNowBtn.style.display = 'block';
        
        // Stop polling when doctor is ready
        if (statusPollInterval) {
          clearInterval(statusPollInterval);
        }
      } else if (data.video_call_status === 'completed' || data.video_call_status === 'ended') {
        // Call ended
        statusIndicator.style.background = '#fee2e2';
        statusIndicator.style.borderColor = '#fecaca';
        statusText.textContent = '‚ùå This consultation has ended';
        statusText.style.color = '#991b1b';
        
        waitingIcon.textContent = 'üìµ';
        waitingTitle.textContent = 'Call Ended';
        waitingSubtitle.textContent = 'This video consultation has already been completed';
        
        joinNowBtn.style.display = 'none';
        
        if (statusPollInterval) {
          clearInterval(statusPollInterval);
        }
      } else {
        // Still waiting for doctor
        statusIndicator.style.background = '#fef3c7';
        statusIndicator.style.borderColor = '#fcd34d';
        statusText.textContent = '‚è≥ Waiting for doctor to start the call...';
        statusText.style.color = '#92400e';
        
        waitingIcon.textContent = '‚è≥';
        waitingTitle.textContent = 'Waiting for Doctor';
        waitingSubtitle.textContent = 'Please wait, your doctor will start the call soon';
        
        joinNowBtn.style.display = 'none';
      }
    }

    function startStatusPolling() {
      // Poll every 5 seconds
      statusPollInterval = setInterval(async () => {
        try {
          const statusUrl = `/bookings/${appointmentId}/video-status${currentMobile ? '?mobile=' + currentMobile : ''}`;
          const response = await fetch(statusUrl);
          const data = await response.json();
          
          if (data.success) {
            updateWaitingStatus(data);
          }
        } catch (err) {
          console.error('Status poll error:', err);
        }
      }, 5000);
    }

    // Back button
    backBtn.addEventListener('click', () => {
      if (statusPollInterval) {
        clearInterval(statusPollInterval);
      }
      waitingRoom.style.display = 'none';
      joinForm.style.display = 'block';
    });

    // Join Now button - Redirect to shared video consultation page
    joinNowBtn.addEventListener('click', async () => {
      joinNowBtn.disabled = true;
      joinNowBtn.textContent = 'Connecting...';
      
      try {
        // Update status to patient_joined
        await fetch(`/bookings/${appointmentId}/video-status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_call_status: 'patient_joined' })
        });
        
        // Redirect to shared video consultation page with patient role
        const videoUrl = `/video_consultation.html` +
          `?appointment_id=${encodeURIComponent(appointmentId)}` +
          `&role=patient` +
          `&doctor_name=${encodeURIComponent(doctorName)}` +
          `&patient_name=${encodeURIComponent(patientName)}`;
        
        window.location.href = videoUrl;
        
      } catch (err) {
        console.error('Join error:', err);
        joinNowBtn.disabled = false;
        joinNowBtn.textContent = 'üé• Join Video Call Now';
        showError('Failed to join. Please try again.');
      }
    });

    function showError(message) {
      error.textContent = message;
      error.style.display = 'block';
    }
  </script>
</body>
</html>
